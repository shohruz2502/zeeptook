<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Google</title>
</head>
<body>
    <div style="text-align: center; margin-top: 100px;">
        <h1>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</h1>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
    </div>

    <script>
    console.log('üîó Google callback page loaded');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏
    const referrer = document.referrer;
    console.log('üîó Referrer:', referrer);
    console.log('üîó Current URL:', window.location.href);

    async function handleGoogleCallback() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const error = params.get('error');

        console.log('üìä Callback parameters:', { code: !!code, state: !!state, error });

        // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        if (code || error) {
            history.replaceState(null, null, window.location.pathname);
        }

        if (error) {
            console.error('‚ùå OAuth error:', error);
            localStorage.setItem('google_auth_error', error);
            
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ register.html
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage({ 
                    type: 'oauth_error', 
                    error: error 
                }, '*');
                window.close();
            } else {
                window.location.href = 'register.html';
            }
            return;
        }

        if (code && state) {
            try {
                console.log('‚úÖ Valid OAuth callback received');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º state
                const savedState = sessionStorage.getItem('google_oauth_state');
                console.log('üîê State check:', { 
                    received: state, 
                    saved: savedState, 
                    match: state === savedState 
                });
                
                if (state !== savedState) {
                    throw new Error('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. State –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.');
                }

                sessionStorage.removeItem('google_oauth_state');

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –≤ sessionStorage
                sessionStorage.setItem('google_auth_code', code);
                sessionStorage.setItem('google_auth_state', state);
                console.log('üíæ Code saved to sessionStorage');

                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                console.log('üîÑ Redirecting to register.html...');
                
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ popup, –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({ 
                        type: 'oauth_code', 
                        code: code, 
                        state: state 
                    }, '*');
                    setTimeout(() => window.close(), 500);
                } else {
                    // –ò–Ω–∞—á–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç
                    window.location.href = 'register.html';
                }

            } catch (error) {
                console.error('‚ùå Callback error:', error);
                localStorage.setItem('google_auth_error', error.message);
                window.location.href = 'register.html';
            }
        } else {
            console.warn('‚ö†Ô∏è No code or state in callback');
            window.location.href = 'register.html';
        }
    }

    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
    window.addEventListener('message', function(event) {
        console.log('üì© Message received in callback:', event.data);
    });

    document.addEventListener('DOMContentLoaded', handleGoogleCallback);
</script>
</body>
</html>
