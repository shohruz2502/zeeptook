<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zeeptook - Игровые аккаунты</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css>
    <style>
    /* ОПТИМИЗИРОВАННЫЕ СТИЛИ ДЛЯ БЫСТРОЙ ЗАГРУЗКИ */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        -webkit-tap-highlight-color: transparent;
    }
    
    :root {
        --primary: #0088cc;
        --primary-dark: #0077b3;
        --secondary: #18222d;
        --accent: #ff6b6b;
        --gray-dark: #2a2f36;
        --gray-medium: #3c4350;
        --gray-light: #8e98a3;
        --white: #ffffff;
        --chat-bg: #0e1621;
        --input-bg: #242f3d;
        --nav-bg: #17212b;
        --skeleton-bg: #2a2f36;
        --skeleton-shine: rgba(255, 255, 255, 0.05);
        --gradient: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        --radius: 12px;
        --radius-sm: 8px;
    }
    
    html, body {
        height: 100%;
        overflow-x: hidden;
        background: var(--chat-bg);
        color: var(--white);
        scroll-behavior: smooth;
    }
    
    body {
        font-size: 15px;
        opacity: 0;
        animation: pageFadeIn 0.3s ease forwards;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 0;
        margin: 0;
        max-width: 768px;
        margin: 0 auto;
        width: 100%;
    }

    @keyframes pageFadeIn {
        to { opacity: 1; }
    }

    .app-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        width: 100%;
        position: relative;
    }

    /* Header */
    .header {
        background: var(--nav-bg);
        color: var(--white);
        padding: 8px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 56px;
        border-bottom: 1px solid var(--gray-dark);
        max-width: 768px;
        margin: 0 auto;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .logo {
        font-size: 17px;
        font-weight: 600;
        color: var(--white);
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .logo i {
        color: var(--primary);
        font-size: 18px;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .messages-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: var(--gradient);
        color: var(--white);
        border: none;
        border-radius: 50%;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        box-shadow: 0 2px 6px rgba(0, 136, 204, 0.3);
    }
    
    .messages-btn:active {
        transform: scale(0.95);
    }
    
    .messages-btn i {
        font-size: 16px;
    }

    /* Search Section */
    .search-section {
        background: var(--nav-bg);
        border-bottom: 1px solid var(--gray-dark);
        padding: 8px 16px;
        position: fixed;
        top: 56px;
        z-index: 999;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 768px;
        margin: 0 auto;
        left: 0;
        right: 0;
        height: 60px;
        display: flex;
        align-items: center;
    }
    
    .search-container {
        position: relative;
        width: 100%;
    }
    
    .search-box {
        display: flex;
        width: 100%;
        border-radius: 20px;
        overflow: hidden;
        background: var(--input-bg);
        border: 1px solid var(--gray-dark);
        transition: all 0.2s ease;
        height: 44px;
    }
    
    .search-box:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.2);
    }
    
    .search-box input {
        flex-grow: 1;
        padding: 10px 16px 10px 44px;
        border: none;
        background: transparent;
        font-size: 14px;
        outline: none;
        color: var(--white);
        width: 100%;
    }
    
    .search-box input::placeholder {
        color: var(--gray-light);
        font-size: 13px;
    }
    
    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-light);
        font-size: 16px;
        pointer-events: none;
    }
    
    .search-box button {
        background: transparent;
        color: var(--gray-light);
        border: none;
        padding: 0 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 44px;
        font-size: 14px;
    }
    
    .search-box button:active {
        transform: scale(0.95);
    }

    /* Categories */
    .categories-section {
        background: var(--nav-bg);
        border-bottom: 1px solid var(--gray-dark);
        position: fixed;
        z-index: 998;
        top: 116px;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 768px;
        margin: 0 auto;
        left: 0;
        right: 0;
        height: 48px;
        will-change: transform;
        transform: translateY(0);
    }
    
    .categories-scroll {
        display: flex;
        overflow-x: auto;
        padding: 8px 16px;
        gap: 6px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        height: 100%;
        align-items: center;
    }
    
    .categories-scroll::-webkit-scrollbar {
        display: none;
    }
    
    .category {
        flex: 0 0 auto;
        padding: 6px 14px;
        background: var(--input-bg);
        border-radius: 18px;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s ease;
        border: 1px solid var(--gray-dark);
        cursor: pointer;
        color: var(--gray-light);
    }
    
    .category.active {
        background: var(--gradient);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 2px 6px rgba(0, 136, 204, 0.3);
    }
    
    .category:active {
        transform: scale(0.95);
    }

    /* Main Content Area */
    .content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-top: 56px;
        margin-bottom: 60px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-top: 108px; /* header + search + categories */
    }

    /* Main Content */
    .main-content {
        flex: 1;
        padding: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Section Header */
    .section-header {
        padding: 16px 16px 12px;
        background: var(--chat-bg);
        position: sticky;
        top: 108px;
        z-index: 990;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--white);
    }

    /* Ads Grid - ОПТИМИЗИРОВАННЫЙ: 2 КОЛОНКИ */
    .ads-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 0 16px 16px;
        background: var(--chat-bg);
        min-height: 200px;
    }

    /* Ad Card - УПРОЩЕННАЯ ВЕРСИЯ ДЛЯ БЫСТРОЙ ЗАГРУЗКИ */
    .ad-card {
        background: var(--nav-bg);
        border-radius: var(--radius);
        overflow: hidden;
        cursor: pointer;
        border: 1px solid var(--gray-dark);
        display: flex;
        flex-direction: column;
        min-height: 320px;
        position: relative;
        transition: transform 0.2s ease;
    }
    
    .ad-card:active {
        transform: scale(0.98);
    }
    
    /* Упрощенный скелетон */
    .ad-card.skeleton {
        background: var(--nav-bg);
        border: 1px solid var(--gray-dark);
        border-radius: var(--radius);
        min-height: 320px;
        position: relative;
        overflow: hidden;
    }
    
    .ad-card.skeleton::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, var(--skeleton-shine), transparent);
        animation: skeletonShine 1.5s infinite;
    }
    
    @keyframes skeletonShine {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    /* Ad Image - ФИКСИРОВАННАЯ ВЫСОТА ДЛЯ МОБИЛЬНЫХ */
    .ad-image {
        position: relative;
        width: 100%;
        height: 140px;
        background: linear-gradient(135deg, #1c2836 0%, #2a2f36 100%);
        overflow: hidden;
        border-radius: var(--radius) var(--radius) 0 0;
    }
    
    .ad-image-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .ad-image-img.loaded {
        opacity: 1;
    }
    
    .ad-image-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--gray-light);
        gap: 8px;
        background: linear-gradient(135deg, #1c2836 0%, #2a2f36 100%);
        font-size: 12px;
    }
    
    .ad-image-placeholder i {
        font-size: 24px;
        opacity: 0.5;
    }
    
    /* Ad Content - ВСЕ ТЕКСТОВЫЕ ДАННЫЕ СРАЗУ ВИДНЫ */
    .ad-content {
        padding: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .ad-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 6px;
    }
    
    .ad-category {
        font-size: 11px;
        background: rgba(0, 136, 204, 0.15);
        padding: 3px 8px;
        border-radius: 10px;
        color: var(--primary);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70%;
    }
    
    .ad-favorite {
        color: var(--gray-light);
        background: transparent;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    
    .ad-favorite.active {
        color: var(--accent);
    }
    
    .ad-favorite:active {
        transform: scale(0.9);
    }
    
    .ad-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--white);
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 40px;
    }
    
    .ad-description {
        color: var(--gray-light);
        margin-bottom: 8px;
        font-size: 13px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        flex: 1;
    }
    
    .ad-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .ad-price {
        font-weight: 700;
        color: var(--primary);
        font-size: 16px;
    }
    
    .ad-meta {
        font-size: 11px;
        color: var(--gray-light);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: var(--nav-bg);
        margin: 16px;
        border-radius: var(--radius);
        border: 1px solid var(--gray-dark);
        grid-column: 1 / -1;
    }
    
    .empty-state i {
        font-size: 48px;
        color: var(--gray-light);
        margin-bottom: 20px;
        opacity: 0.6;
    }
    
    .empty-state h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: var(--white);
        font-weight: 500;
    }
    
    .empty-state p {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 25px;
        color: var(--gray-light);
    }

    /* Loading Spinner */
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 136, 204, 0.2);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Load More Button */
    .load-more {
        text-align: center;
        padding: 20px 16px;
        background: var(--chat-bg);
        grid-column: 1 / -1;
    }
    
    .load-more-btn {
        padding: 14px 28px;
        border: 1px solid var(--primary);
        border-radius: 25px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        background: transparent;
        color: var(--primary);
        width: 100%;
        max-width: 220px;
    }
    
    .load-more-btn:active {
        transform: scale(0.97);
        background: rgba(0, 136, 204, 0.1);
    }
    
    .load-more-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Error State */
    .error-state {
        text-align: center;
        padding: 60px 20px;
        background: var(--nav-bg);
        margin: 16px;
        border-radius: var(--radius);
        border: 1px solid var(--gray-dark);
        grid-column: 1 / -1;
    }
    
    .error-state i {
        font-size: 48px;
        color: var(--accent);
        margin-bottom: 20px;
        opacity: 0.7;
    }
    
    .error-state h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: var(--white);
        font-weight: 500;
    }
    
    .error-state p {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
        color: var(--gray-light);
    }
    
    .retry-btn {
        padding: 14px 24px;
        border: 1px solid var(--primary);
        border-radius: 25px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        background: transparent;
        color: var(--primary);
        width: 100%;
        max-width: 220px;
    }
    
    .retry-btn:active {
        transform: scale(0.97);
        background: rgba(0, 136, 204, 0.1);
    }

    /* Bottom Navigation */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--nav-bg);
        display: flex;
        justify-content: space-around;
        padding: 8px 0 10px;
        border-top: 1px solid var(--gray-dark);
        z-index: 1000;
        height: 60px;
        max-width: 768px;
        margin: 0 auto;
    }
    
    .nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--gray-light);
        font-size: 10px;
        padding: 6px 4px;
        transition: all 0.2s ease;
        flex: 1;
        position: relative;
        border: none;
        background: none;
        cursor: pointer;
    }
    
    .nav-btn i {
        font-size: 20px;
        margin-bottom: 2px;
        transition: all 0.2s ease;
    }
    
    .nav-btn.active {
        color: var(--primary);
    }
    
    .nav-btn.active i {
        transform: translateY(-1px);
    }
    
    .nav-btn.active::after {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 30px;
        height: 3px;
        background: var(--primary);
        border-radius: 2px;
    }
    
    .nav-btn:active {
        transform: scale(0.95);
    }

    /* Quick Notification */
    .quick-notification {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        animation: slideDown 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        max-width: 90%;
        text-align: center;
    }

    /* Animations */
    @keyframes slideDown {
        from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
    }

    /* АДАПТАЦИЯ ДЛЯ РАЗНЫХ УСТРОЙСТВ */
    @media (max-width: 480px) {
        .ad-image {
            height: 130px;
        }
        
        .ad-card {
            min-height: 300px;
        }
        
        .ad-title {
            font-size: 14px;
            min-height: 36px;
        }
        
        .ad-price {
            font-size: 15px;
        }
        
        .ad-description {
            font-size: 12px;
        }
        
        .categories-scroll {
            padding: 8px 16px;
        }
        
        .category {
            padding: 5px 12px;
            font-size: 12px;
        }
        
        .content-wrapper {
            padding-top: 104px;
        }
        
        .section-header {
            top: 104px;
        }
        
        .search-box {
            height: 40px;
        }
        
        .search-box input {
            padding: 8px 16px 8px 40px;
            font-size: 13px;
        }
        
        .search-icon {
            left: 12px;
            font-size: 15px;
        }
        
        .header {
            padding: 8px 12px;
        }
        
        .logo {
            font-size: 16px;
        }
    }
    
    @media (min-width: 481px) and (max-width: 768px) {
        .ad-image {
            height: 150px;
        }
        
        .ad-card {
            min-height: 330px;
        }
    }
    
    @media (max-width: 360px) {
        .ads-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .ad-image {
            height: 160px;
        }
        
        .ad-card {
            min-height: 320px;
        }
    }

    /* Ховер-эффекты для ПК (если нужно) */
    @media (hover: hover) and (pointer: fine) {
        .ad-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .category:hover:not(.active) {
            background: var(--gray-medium);
        }
        
        .ad-favorite:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .load-more-btn:hover {
            background: rgba(0, 136, 204, 0.1);
        }
    }

    /* Стили для индикатора загрузки изображений */
    .image-loading {
        position: relative;
    }
    
    .image-loading::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
        animation: loadingShine 1.5s infinite;
    }
    
    @keyframes loadingShine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* Улучшенные скроллбары */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    ::-webkit-scrollbar-track {
        background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
        background: var(--gray-dark);
        border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: var(--gray-medium);
    }

    /* Оптимизация для производительности */
    .will-change-transform {
        will-change: transform;
    }
    
    .will-change-opacity {
        will-change: opacity;
    }

    /* Стили для состояния "нет интернета" */
    .offline-indicator {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: var(--accent);
        color: white;
        text-align: center;
        padding: 8px;
        font-size: 13px;
        z-index: 10001;
        animation: slideDown 0.3s ease;
    }

    /* Оптимизация для ретина-дисплеев */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .ad-image {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
    }

    /* Поддержка темной темы систем */
    @media (prefers-color-scheme: dark) {
        :root {
            --gray-dark: #1a1f27;
            --gray-medium: #2c3440;
        }
    }

    /* Оптимизация для iOS */
    @supports (-webkit-touch-callout: none) {
        .content-wrapper {
            /* iOS requires this for smooth scrolling */
            -webkit-overflow-scrolling: touch;
        }
        
        .ad-card:active {
            /* Уменьшаем эффект нажатия для iOS */
            transform: scale(0.98);
        }
    }
</style>
</head>
<body>
    <div class="app-container">
        <!-- ХЕДЕР -->
        <div class="header">
            <div class="logo">
                <i class="fa fa-diamond"></i>
                <span>Zeeptook</span>
            </div>
            <div class="header-actions">
                <a href="messages.html" class="messages-btn">
                    <i class="fa fa-comment"></i>
                </a>
            </div>
        </div>
        
        <!-- ПОИСК -->
        <div class="search-section" id="search-section">
            <div class="search-container">
                <div class="search-box">
                    <div class="search-icon">
                        <i class="fa fa-search"></i>
                    </div>
                    <input type="text" id="search-input" placeholder="Поиск игровых аккаунтов...">
                    <button id="search-clear-btn" style="display: none;">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- КАТЕГОРИИ -->
        <div class="categories-section" id="categories-section">
            <div class="categories-scroll" id="categories-container">
                <!-- Категории будут загружены -->
            </div>
        </div>
        
        <!-- ОСНОВНОЙ КОНТЕНТ -->
        <div class="content-wrapper">
            <div class="main-content">
                <div class="section-header">
                    <div class="section-title">Игровые аккаунты</div>
                </div>
                
                <div class="ads-grid" id="ads-container">
                    <!-- Быстрые скелетоны для начальной загрузки -->
                    <div class="ad-card skeleton"></div>
                    <div class="ad-card skeleton"></div>
                </div>
                
                <div class="load-more">
                    <button class="load-more-btn" id="load-more-btn" style="display: none;">Показать ещё</button>
                </div>
            </div>
        </div>
        
        <!-- НИЖНЕЕ МЕНЮ -->
        <div class="bottom-nav">
            <a href="index.html" class="nav-btn active">
                <i class="fa fa-home"></i>
                <span>Главная</span>
            </a>
            <a href="favorites.html" class="nav-btn">
                <i class="fa fa-heart"></i>
                <span>Избранное</span>
            </a>
            <a href="add-ad.html" class="nav-btn">
                <i class="fa fa-plus"></i>
                <span>Добавить</span>
            </a>
            <a href="server-page.html" class="nav-btn">
                <i class="fa fa-gamepad"></i>
                <span>Серверы</span>
            </a>
            <a href="profile.html" class="nav-btn">
                <i class="fa fa-user"></i>
                <span>Профиль</span>
            </a>
        </div>
    </div>

    <script>
    // ОПТИМИЗИРОВАННЫЕ ПЕРЕМЕННЫЕ
    let currentPage = 1;
    let totalPages = 1;
    let currentCategory = 'all';
    let currentSearch = '';
    let isLoading = false;
    let isCategoriesHidden = false;
    let token = localStorage.getItem('token');
    let imageLoadingQueue = [];
    let isImageLoadingActive = false;
    
    // Кеш для данных с улучшенной логикой
    const DATA_CACHE = {
        set: function(key, data, category = 'all') {
            const cacheKey = `${category}_${key}`;
            const cacheData = {
                data: data,
                timestamp: Date.now(),
                category: category
            };
            try {
                localStorage.setItem(`cache_${cacheKey}`, JSON.stringify(cacheData));
            } catch (e) {
                // Очищаем старые записи при переполнении
                this.clearOldEntries();
            }
        },
        
        get: function(key, category = 'all', maxAge = 300000) {
            const cacheKey = `${category}_${key}`;
            try {
                const cached = localStorage.getItem(`cache_${cacheKey}`);
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                const age = Date.now() - cacheData.timestamp;
                
                if (age > maxAge || cacheData.category !== category) {
                    localStorage.removeItem(`cache_${cacheKey}`);
                    return null;
                }
                
                return cacheData.data;
            } catch (e) {
                return null;
            }
        },
        
        clearOldEntries: function() {
            const oneHourAgo = Date.now() - 3600000;
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('cache_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data && data.timestamp < oneHourAgo) {
                            localStorage.removeItem(key);
                        }
                    } catch (e) {
                        localStorage.removeItem(key);
                    }
                }
            });
        }
    };
    
    // Базовый URL API
    const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api';
    
    // Игровые категории
    const gameCategories = [
        { name: 'Все', data: 'all' },
        { name: 'PUBG Mobile', data: 'pubg' },
        { name: 'Free Fire', data: 'freefire' },
        { name: 'Call of Duty', data: 'cod' },
        { name: 'Genshin Impact', data: 'genshin' },
        { name: 'Mobile Legends', data: 'ml' },
        { name: 'Clash of Clans', data: 'coc' },
        { name: 'Brawl Stars', data: 'brawl' },
        { name: 'Roblox', data: 'roblox' }
    ];

    // 1. БЫСТРАЯ ЗАГРУЗКА КАТЕГОРИЙ
    function loadCategories() {
        const container = document.getElementById('categories-container');
        container.innerHTML = '';
        
        gameCategories.forEach(cat => {
            const categoryElement = document.createElement('div');
            categoryElement.className = cat.data === 'all' ? 'category active' : 'category';
            categoryElement.textContent = cat.name;
            categoryElement.setAttribute('data-category', cat.data);
            container.appendChild(categoryElement);
        });
        
        setupCategories();
    }

    // 2. ОПТИМИЗИРОВАННАЯ ЗАГРУЗКА ОБЪЯВЛЕНИЙ
    async function fetchAds(page = 1, category = 'all', search = '') {
        if (isLoading) return;
        
        isLoading = true;
        const adsContainer = document.getElementById('ads-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        
        try {
            // Для первой страницы - минимальная задержка для скелетонов
            if (page === 1) {
                adsContainer.innerHTML = `
                    <div class="ad-card skeleton"></div>
                    <div class="ad-card skeleton"></div>
                    <div class="ad-card skeleton"></div>
                    <div class="ad-card skeleton"></div>
                `;
                loadMoreBtn.style.display = 'none';
                
                // ОЧЕНЬ КОРОТКИЙ ТАЙМАУТ ДЛЯ СКЕЛЕТОНОВ (чтобы пользователь сразу видел загрузку)
                await new Promise(resolve => setTimeout(resolve, 50));
            } else {
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'Загрузка...';
            }

            // Проверяем кеш только для первой страницы без поиска
            if (page === 1 && !search) {
                const cachedData = DATA_CACHE.get(`page_${page}`, category, 120000); // 2 минуты
                if (cachedData) {
                    // МГНОВЕННО показываем кешированные данные
                    displayAdsCards(cachedData.ads || [], true);
                    currentPage = cachedData.page || page;
                    totalPages = cachedData.totalPages || 1;
                    
                    // Асинхронно загружаем изображения
                    setTimeout(() => {
                        loadImagesForAds(cachedData.ads || []);
                    }, 100);
                    
                    // Показываем кнопку "загрузить еще" если нужно
                    if (currentPage < totalPages) {
                        loadMoreBtn.style.display = 'block';
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.textContent = 'Показать ещё';
                    }
                    
                    // Параллельно загружаем свежие данные
                    setTimeout(() => fetchFreshAds(page, category, search), 300);
                    isLoading = false;
                    return;
                }
            }
            
            // Загружаем свежие данные
            await fetchFreshAds(page, category, search);
            
        } catch (error) {
            console.error('Ошибка загрузки:', error);
            
            // Показываем кешированные данные или сообщение об ошибке
            if (page === 1) {
                const cachedData = DATA_CACHE.get(`page_${page}`, category, 86400000);
                if (cachedData) {
                    displayAdsCards(cachedData.ads || [], true);
                    setTimeout(() => {
                        loadImagesForAds(cachedData.ads || []);
                    }, 100);
                } else {
                    showErrorState();
                }
            }
        } finally {
            isLoading = false;
        }
    }

    // 3. ЗАГРУЗКА СВЕЖИХ ДАННЫХ С СЕРВЕРА
    async function fetchFreshAds(page, category, search) {
        const loadMoreBtn = document.getElementById('load-more-btn');
        
        // Формируем URL с ЛИМИТОМ 12 элементов (оптимально для парсинга)
        let url;
        try {
            url = new URL(`${API_BASE}/ads`);
        } catch (e) {
            url = new URL('/api/ads', window.location.origin);
        }
        
        url.searchParams.append('page', page);
        url.searchParams.append('limit', '12'); // Ограничиваем количество для быстрого парсинга
        
        if (category !== 'all') {
            url.searchParams.append('category', category);
        }
        if (search) {
            url.searchParams.append('search', search);
        }

        const options = {
            method: 'GET',
            headers: {}
        };

        if (token) {
            options.headers['Authorization'] = `Bearer ${token}`;
        }

        // Уменьшаем таймаут до 5 секунд
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        options.signal = controller.signal;

        const response = await fetch(url.toString(), options);
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`Ошибка ${response.status}`);
        }

        const data = await response.json();
        
        // Кешируем данные для первой страницы без поиска
        if (page === 1 && !search) {
            DATA_CACHE.set(`page_${page}`, data, category);
        }
        
        currentPage = data.page || page;
        totalPages = data.totalPages || 1;
        
        // МГНОВЕННО ОТОБРАЖАЕМ КАРТОЧКИ С ТЕКСТОМ
        displayAdsCards(data.ads || [], page === 1);
        
        // АСИНХРОННО ЗАГРУЖАЕМ ИЗОБРАЖЕНИЯ (после отображения текста)
        setTimeout(() => {
            loadImagesForAds(data.ads || []);
        }, 50);
        
        // Обновляем кнопку "Загрузить еще"
        if (currentPage < totalPages) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = 'Показать ещё';
        } else {
            loadMoreBtn.style.display = 'none';
        }
    }

    // 4. ОТОБРАЖЕНИЕ КАРТОЧЕК СРАЗУ С ТЕКСТОМ (БЕЗ ИЗОБРАЖЕНИЙ)
    function displayAdsCards(adsArray, clearContainer = true) {
        const adsContainer = document.getElementById('ads-container');
        
        if (clearContainer) {
            adsContainer.innerHTML = '';
        }
        
        if (adsArray.length === 0 && clearContainer) {
            adsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fa fa-inbox"></i>
                    <h3>Объявления не найдены</h3>
                    <p>Попробуйте изменить параметры поиска</p>
                </div>
            `;
            return;
        }
        
        // СОЗДАЕМ КАРТОЧКИ СРАЗУ С ТЕКСТОМ
        adsArray.forEach((ad, index) => {
            const adElement = createAdCardWithoutImages(ad, index);
            adsContainer.appendChild(adElement);
        });
    }

    // 5. СОЗДАНИЕ КАРТОЧКИ БЕЗ ИЗОБРАЖЕНИЙ (ТОЛЬКО ТЕКСТ)
    function createAdCardWithoutImages(ad, index) {
        const adElement = document.createElement('div');
        adElement.className = 'ad-card';
        adElement.setAttribute('data-ad-id', ad.id || index);
        
        // Форматируем данные
        const priceFormatted = ad.price ? 
            new Intl.NumberFormat('ru-RU').format(ad.price) + ' ₽' : 
            'Договорная';
        
        const timeAgo = formatTimeAgo(ad.created_at);
        const gameName = getGameNameFromCategory(ad.category);
        
        // Проверяем избранное
        const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        const isFavorite = favorites.some(fav => fav.id === ad.id);
        
        // HTML КАРТОЧКИ С ЗАГЛУШКОЙ ДЛЯ ИЗОБРАЖЕНИЯ
        adElement.innerHTML = `
            <div class="ad-image" data-ad-id="${ad.id || index}">
                <div class="ad-image-placeholder">
                    <i class="fa fa-gamepad"></i>
                    <span>Загрузка изображения...</span>
                </div>
                <!-- Изображение будет добавлено позже -->
            </div>
            <div class="ad-content">
                <div class="ad-header">
                    <div class="ad-category">${gameName}</div>
                    <button class="ad-favorite ${isFavorite ? 'active' : ''}" data-ad-id="${ad.id || index}">
                        <i class="fa fa-heart"></i>
                    </button>
                </div>
                <div class="ad-title">${ad.title || 'Игровой аккаунт'}</div>
                <div class="ad-description">${ad.description || 'Аккаунт с хорошими характеристиками'}</div>
                <div class="ad-footer">
                    <div class="ad-price">${priceFormatted}</div>
                    <div class="ad-meta">
                        <span>${timeAgo}</span>
                    </div>
                </div>
            </div>
        `;
        
        // Настройка избранного
        const favoriteBtn = adElement.querySelector('.ad-favorite');
        favoriteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFavorite(ad.id || index, favoriteBtn, ad);
        });
        
        // Клик по карточке
        adElement.addEventListener('click', () => {
            openAdDetails(ad.id || index);
        });
        
        return adElement;
    }

    // 6. ОПТИМИЗИРОВАННАЯ ЗАГРУЗКА ИЗОБРАЖЕНИЙ
    function loadImagesForAds(adsToLoad) {
        // Очищаем очередь
        imageLoadingQueue = [];
        
        // Добавляем в очередь только видимые элементы
        adsToLoad.forEach((ad, index) => {
            const imageContainer = document.querySelector(`.ad-image[data-ad-id="${ad.id || index}"]`);
            if (imageContainer && isElementInViewport(imageContainer)) {
                imageLoadingQueue.push({
                    adId: ad.id || index,
                    ad: ad,
                    container: imageContainer
                });
            }
        });
        
        // Запускаем загрузку
        if (!isImageLoadingActive) {
            processImageQueue();
        }
    }

    // 7. ОЧЕРЕДЬ ЗАГРУЗКИ ИЗОБРАЖЕНИЙ
    function processImageQueue() {
        if (imageLoadingQueue.length === 0) {
            isImageLoadingActive = false;
            return;
        }
        
        isImageLoadingActive = true;
        
        // Берем первые 2 изображения для параллельной загрузки
        const batchSize = Math.min(2, imageLoadingQueue.length);
        
        for (let i = 0; i < batchSize; i++) {
            const item = imageLoadingQueue.shift();
            if (item) {
                loadSingleImage(item);
            }
        }
        
        // Продолжаем через задержку
        setTimeout(() => {
            processImageQueue();
        }, 200);
    }

    // 8. ЗАГРУЗКА ОДНОГО ИЗОБРАЖЕНИЯ
    function loadSingleImage({ adId, ad, container }) {
        const placeholder = container.querySelector('.ad-image-placeholder');
        
        // Получаем URL изображения с ОПТИМИЗИРОВАННЫМ РАЗРЕШЕНИЕМ
        let imageUrl = getOptimizedImageUrl(ad);
        
        if (!imageUrl) {
            if (placeholder) {
                placeholder.querySelector('span').textContent = 'Нет изображения';
            }
            return;
        }
        
        // Создаем объект Image для предзагрузки
        const img = new Image();
        
        img.onload = function() {
            // Создаем элемент для вставки
            const imgElement = document.createElement('img');
            imgElement.className = 'ad-image-img';
            imgElement.src = imageUrl;
            imgElement.alt = ad.title || 'Игровой аккаунт';
            imgElement.loading = 'lazy';
            imgElement.style.width = '100%';
            imgElement.style.height = '100%';
            imgElement.style.objectFit = 'cover';
            imgElement.style.borderRadius = 'var(--radius) var(--radius) 0 0';
            
            // Заменяем содержимое контейнера
            container.innerHTML = '';
            container.appendChild(imgElement);
            
            // Плавное появление
            setTimeout(() => {
                imgElement.classList.add('loaded');
            }, 50);
        };
        
        img.onerror = function() {
            // Ошибка загрузки - оставляем заглушку
            if (placeholder) {
                placeholder.querySelector('span').textContent = 'Ошибка загрузки';
            }
        };
        
        // Начинаем загрузку
        img.src = imageUrl;
    }

    // 9. ПОЛУЧЕНИЕ ОПТИМИЗИРОВАННОГО URL ИЗОБРАЖЕНИЯ
    function getOptimizedImageUrl(ad) {
        let imageUrl = '';
        
        // Если есть photos массив от сервера
        if (ad.photos && ad.photos.length > 0) {
            const firstPhoto = ad.photos[0];
            if (firstPhoto.image_data) {
                if (firstPhoto.image_data.startsWith('data:image')) {
                    imageUrl = firstPhoto.image_data;
                } 
                else if (firstPhoto.image_data.startsWith('http')) {
                    // ДОБАВЛЯЕМ ПАРАМЕТРЫ ДЛЯ ОПТИМИЗАЦИИ РАЗМЕРА
                    imageUrl = optimizeImageUrl(firstPhoto.image_data);
                }
                else if (firstPhoto.image_data.length > 100) {
                    imageUrl = `data:image/jpeg;base64,${firstPhoto.image_data}`;
                }
            }
        }
        // Если есть image поле в самом объявлении
        else if (ad.image) {
            if (ad.image.startsWith('data:image')) {
                imageUrl = ad.image;
            }
            else if (ad.image.startsWith('http')) {
                imageUrl = optimizeImageUrl(ad.image);
            }
        }
        
        return imageUrl;
    }

    // 10. ОПТИМИЗАЦИЯ URL ИЗОБРАЖЕНИЯ ДЛЯ МОБИЛЬНЫХ
    function optimizeImageUrl(url) {
        // Для Unsplash
        if (url.includes('unsplash.com')) {
            return url + '&w=400&h=300&fit=crop&crop=faces';
        }
        // Для других изображений - добавляем параметры для ресайза
        else if (url.includes('cloudinary') || url.includes('imgur')) {
            // Добавляем параметры для уменьшения размера
            const separator = url.includes('?') ? '&' : '?';
            return url + separator + 'w=400&h=300&fit=cover';
        }
        
        return url;
    }

    // 11. ПРОВЕРКА ВИДИМОСТИ ЭЛЕМЕНТА
    function isElementInViewport(el) {
        const rect = el.getBoundingClientRect();
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) * 1.5 &&
            rect.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
    }

    // 12. ПОЛУЧЕНИЕ НАЗВАНИЯ ИГРЫ
    function getGameNameFromCategory(category) {
        const gameMap = {
            'pubg': 'PUBG Mobile',
            'freefire': 'Free Fire',
            'cod': 'Call of Duty',
            'genshin': 'Genshin Impact',
            'ml': 'Mobile Legends',
            'coc': 'Clash of Clans',
            'brawl': 'Brawl Stars',
            'roblox': 'Roblox'
        };
        
        return gameMap[category] || category || 'Игры';
    }

    // 13. ФОРМАТИРОВАНИЕ ВРЕМЕНИ
    function formatTimeAgo(dateString) {
        if (!dateString) return '> нед';
        
        try {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays < 1) return 'сегодня';
            if (diffDays < 2) return 'вчера';
            if (diffDays < 7) return `${diffDays} д`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} нед`;
            return `${Math.floor(diffDays / 30)} мес`;
        } catch (e) {
            return '> нед';
        }
    }

    // 14. ИЗБРАННОЕ
    function toggleFavorite(adId, favoriteBtn, ad) {
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        
        if (favoriteBtn.classList.contains('active')) {
            favorites = favorites.filter(fav => fav.id !== adId);
            favoriteBtn.classList.remove('active');
            showNotification('Удалено из избранного');
        } else {
            const favoriteAd = {
                id: adId,
                title: ad.title,
                price: ad.price,
                category: ad.category,
                description: ad.description
            };
            favorites.push(favoriteAd);
            favoriteBtn.classList.add('active');
            showNotification('Добавлено в избранное');
        }
        
        localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    // 15. ОТКРЫТИЕ ДЕТАЛЕЙ
    function openAdDetails(adId) {
        window.location.href = `ad-details.html?id=${adId}`;
    }

    // 16. УВЕДОМЛЕНИЯ
    function showNotification(message) {
        const existing = document.querySelector('.quick-notification');
        if (existing) existing.remove();
        
        const notification = document.createElement('div');
        notification.className = 'quick-notification';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }

    // 17. ОШИБКА
    function showErrorState() {
        const adsContainer = document.getElementById('ads-container');
        adsContainer.innerHTML = `
            <div class="error-state">
                <i class="fa fa-exclamation-triangle"></i>
                <h3>Ошибка загрузки</h3>
                <p>Проверьте подключение к интернету</p>
                <button class="retry-btn" onclick="fetchAds(1, currentCategory, currentSearch)">Повторить</button>
            </div>
        `;
    }

    // 18. НАСТРОЙКА ПОИСКА
    function setupSearch() {
        const searchInput = document.getElementById('search-input');
        const searchClearBtn = document.getElementById('search-clear-btn');
        
        const performSearch = () => {
            currentSearch = searchInput.value.trim();
            currentPage = 1;
            fetchAds(1, currentCategory, currentSearch);
            
            if (currentSearch) {
                searchClearBtn.style.display = 'block';
            } else {
                searchClearBtn.style.display = 'none';
            }
        };
        
        searchClearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchClearBtn.style.display = 'none';
            performSearch();
        });
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });
        
        let searchTimer;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(performSearch, 500);
            
            if (searchInput.value.trim()) {
                searchClearBtn.style.display = 'block';
            } else {
                searchClearBtn.style.display = 'none';
            }
        });
    }

    // 19. НАСТРОЙКА КАТЕГОРИЙ
    function setupCategories() {
        const categories = document.querySelectorAll('.category');
        categories.forEach(category => {
            category.addEventListener('click', function() {
                const categoryValue = this.getAttribute('data-category');
                
                categories.forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                currentCategory = categoryValue;
                currentPage = 1;
                currentSearch = '';
                document.getElementById('search-input').value = '';
                document.getElementById('search-clear-btn').style.display = 'none';
                
                fetchAds(1, currentCategory);
            });
        });
    }

    // 20. АНИМАЦИЯ СКРОЛЛА
    function setupScrollAnimation() {
        const categoriesSection = document.getElementById('categories-section');
        const contentWrapper = document.querySelector('.content-wrapper');
        
        let lastScrollPos = 0;
        let ticking = false;
        
        function handleScroll() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > 100 && scrollTop > lastScrollPos && !isCategoriesHidden) {
                categoriesSection.style.transform = 'translateY(-100%)';
                isCategoriesHidden = true;
                contentWrapper.style.paddingTop = '60px';
            } 
            else if ((scrollTop < lastScrollPos || scrollTop <= 50) && isCategoriesHidden) {
                categoriesSection.style.transform = 'translateY(0)';
                isCategoriesHidden = false;
                contentWrapper.style.paddingTop = '108px';
            }
            
            lastScrollPos = scrollTop;
        }
        
        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    handleScroll();
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });
    }

    // 21. ЛЕНИВАЯ ЗАГРУЗКА ПРИ СКРОЛЛЕ
    function setupLazyLoading() {
        let ticking = false;
        
        function checkVisibleImages() {
            const imageContainers = document.querySelectorAll('.ad-image');
            imageContainers.forEach(container => {
                if (isElementInViewport(container) && !container.querySelector('img')) {
                    const adId = container.getAttribute('data-ad-id');
                    // Можно добавить логику для дозагрузки изображений
                }
            });
        }
        
        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    checkVisibleImages();
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });
    }

    // ИНИЦИАЛИЗАЦИЯ
    document.addEventListener('DOMContentLoaded', function() {
        // Загружаем категории
        loadCategories();
        
        // Настраиваем поиск
        setupSearch();
        
        // Настраиваем скролл-анимацию
        setupScrollAnimation();
        
        // Настраиваем ленивую загрузку
        setupLazyLoading();
        
        // ЗАГРУЖАЕМ ОБЪЯВЛЕНИЯ СРАЗУ (пользователь сразу видит скелетоны)
        fetchAds();
        
        // Кнопка "Загрузить еще"
        const loadMoreBtn = document.getElementById('load-more-btn');
        loadMoreBtn.addEventListener('click', () => {
            fetchAds(currentPage + 1, currentCategory, currentSearch);
        });
    });
</script>
</body>
</html>

