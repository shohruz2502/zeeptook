<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zeeptook - Игровые аккаунты</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css>
    <style>
    /* ОПТИМИЗИРОВАННЫЕ СТИЛИ */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        -webkit-tap-highlight-color: transparent;
    }
    
    :root {
        --primary: #0088cc;
        --primary-dark: #0077b3;
        --secondary: #18222d;
        --accent: #ff6b6b;
        --gray-dark: #2a2f36;
        --gray-medium: #3c4350;
        --gray-light: #8e98a3;
        --white: #ffffff;
        --chat-bg: #0e1621;
        --input-bg: #242f3d;
        --nav-bg: #17212b;
        --skeleton-bg: #2a2f36;
        --gradient: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        --radius: 12px;
    }
    
    html, body {
        height: 100%;
        overflow-x: hidden;
        background: var(--chat-bg);
        color: var(--white);
    }
    
    body {
        font-size: 15px;
        opacity: 0;
        animation: pageFadeIn 0.2s ease forwards;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 0;
        margin: 0;
        max-width: 768px;
        margin: 0 auto;
        width: 100%;
    }

    @keyframes pageFadeIn {
        to { opacity: 1; }
    }

    .app-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        width: 100%;
    }

    /* Header - УПРОЩЕННЫЙ */
    .header {
        background: var(--nav-bg);
        color: var(--white);
        padding: 8px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 56px;
        border-bottom: 1px solid var(--gray-dark);
        max-width: 768px;
        margin: 0 auto;
    }
    
    .logo {
        font-size: 17px;
        font-weight: 600;
        color: var(--white);
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .logo i {
        color: var(--primary);
        font-size: 18px;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .messages-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: var(--gradient);
        color: var(--white);
        border: none;
        border-radius: 50%;
        font-size: 15px;
        cursor: pointer;
        transition: transform 0.1s ease;
        text-decoration: none;
    }
    
    .messages-btn:active {
        transform: scale(0.95);
    }

    /* Search Section */
    .search-section {
        background: var(--nav-bg);
        border-bottom: 1px solid var(--gray-dark);
        padding: 12px 16px;
        position: fixed;
        top: 56px;
        z-index: 999;
        max-width: 768px;
        margin: 0 auto;
        left: 0;
        right: 0;
    }
    
    .search-container {
        position: relative;
        width: 100%;
    }
    
    .search-box {
        display: flex;
        width: 100%;
        border-radius: 20px;
        overflow: hidden;
        background: var(--input-bg);
        border: 1px solid var(--gray-dark);
        transition: all 0.2s ease;
        height: 40px;
    }
    
    .search-box:focus-within {
        border-color: var(--primary);
    }
    
    .search-box input {
        flex-grow: 1;
        padding: 10px 16px 10px 44px;
        border: none;
        background: transparent;
        font-size: 14px;
        outline: none;
        color: var(--white);
        width: 100%;
    }
    
    .search-box input::placeholder {
        color: var(--gray-light);
        font-size: 13px;
    }
    
    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-light);
        font-size: 16px;
        pointer-events: none;
    }
    
    .search-box button {
        background: transparent;
        color: var(--gray-light);
        border: none;
        padding: 0 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 44px;
        font-size: 14px;
    }

    /* Categories */
    .categories-section {
        background: var(--nav-bg);
        border-bottom: 1px solid var(--gray-dark);
        position: fixed;
        z-index: 998;
        top: 104px;
        max-width: 768px;
        margin: 0 auto;
        left: 0;
        right: 0;
        height: 48px;
    }
    
    .categories-scroll {
        display: flex;
        overflow-x: auto;
        padding: 8px 16px;
        gap: 6px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        height: 100%;
        align-items: center;
    }
    
    .categories-scroll::-webkit-scrollbar {
        display: none;
    }
    
    .category {
        flex: 0 0 auto;
        padding: 6px 14px;
        background: var(--input-bg);
        border-radius: 18px;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s ease;
        border: 1px solid var(--gray-dark);
        cursor: pointer;
        color: var(--gray-light);
    }
    
    .category.active {
        background: var(--gradient);
        color: white;
        border-color: var(--primary);
    }
    
    .category:active {
        transform: scale(0.95);
    }

    /* Main Content Area */
    .content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-top: 56px;
        margin-bottom: 60px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-top: 152px; /* header + search + categories */
    }

    /* Main Content */
    .main-content {
        flex: 1;
        padding: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Section Header */
    .section-header {
        padding: 16px 16px 12px;
        background: var(--chat-bg);
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--white);
    }

    /* Ads Grid - ОДИН КОЛОНКОЙ ДЛЯ СКОРОЙ ЗАГРУЗКИ */
    .ads-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 0 16px 16px;
        background: var(--chat-bg);
    }

    /* Ad Card - ОПТИМИЗИРОВАННЫЙ ДЛЯ БЫСТРОЙ ЗАГРУЗКИ */
    .ad-card {
        background: var(--nav-bg);
        border-radius: var(--radius);
        overflow: hidden;
        cursor: pointer;
        border: 1px solid var(--gray-dark);
        display: flex;
        animation: cardAppear 0.3s ease-out forwards;
        min-height: 140px;
    }
    
    @keyframes cardAppear {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .ad-card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    /* ЛЕВАЯ ЧАСТЬ: ТЕКСТОВАЯ ИНФОРМАЦИЯ (грузится сразу) */
    .ad-text-content {
        flex: 1;
        padding: 12px;
        display: flex;
        flex-direction: column;
        min-width: 0; /* Для правильного обрезания текста */
    }
    
    .ad-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }
    
    .ad-category {
        font-size: 11px;
        background: rgba(0, 136, 204, 0.15);
        padding: 4px 8px;
        border-radius: 10px;
        color: var(--primary);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70%;
    }
    
    .ad-favorite {
        color: var(--gray-light);
        background: transparent;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    
    .ad-favorite.active {
        color: var(--accent);
    }
    
    .ad-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--white);
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .ad-description {
        color: var(--gray-light);
        margin-bottom: 8px;
        font-size: 13px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        flex: 1;
    }
    
    .ad-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
    }
    
    .ad-price {
        font-weight: 700;
        color: var(--primary);
        font-size: 17px;
    }
    
    .ad-meta {
        font-size: 12px;
        color: var(--gray-light);
    }

    /* ПРАВАЯ ЧАСТЬ: ИЗОБРАЖЕНИЕ (грузится отдельно) */
    .ad-image-container {
        width: 120px;
        height: 140px;
        flex-shrink: 0;
        background: var(--gray-dark);
        position: relative;
        overflow: hidden;
    }
    
    .ad-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .ad-image.loaded {
        opacity: 1;
    }
    
    .image-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--gray-light);
        gap: 6px;
        background: var(--gray-dark);
        font-size: 12px;
    }
    
    .image-placeholder i {
        font-size: 24px;
        opacity: 0.5;
    }

    /* Loading States */
    .initial-loading {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray-light);
    }
    
    .loading-spinner {
        width: 30px;
        height: 30px;
        border: 3px solid rgba(0, 136, 204, 0.2);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Load More Button */
    .load-more {
        text-align: center;
        padding: 20px 16px;
        background: var(--chat-bg);
    }
    
    .load-more-btn {
        padding: 12px 24px;
        border: 1px solid var(--primary);
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        background: transparent;
        color: var(--primary);
        width: 100%;
        max-width: 200px;
    }
    
    .load-more-btn:active {
        transform: scale(0.97);
        background: rgba(0, 136, 204, 0.1);
    }
    
    .load-more-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        background: var(--nav-bg);
        margin: 16px;
        border-radius: var(--radius);
        border: 1px solid var(--gray-dark);
    }
    
    .empty-state i {
        font-size: 36px;
        color: var(--gray-light);
        margin-bottom: 15px;
        opacity: 0.6;
    }
    
    .empty-state h3 {
        font-size: 16px;
        margin-bottom: 8px;
        color: var(--white);
        font-weight: 500;
    }
    
    .empty-state p {
        font-size: 13px;
        line-height: 1.5;
        color: var(--gray-light);
    }

    /* Bottom Navigation */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--nav-bg);
        display: flex;
        justify-content: space-around;
        padding: 8px 0 10px;
        border-top: 1px solid var(--gray-dark);
        z-index: 1000;
        height: 60px;
        max-width: 768px;
        margin: 0 auto;
    }
    
    .nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--gray-light);
        font-size: 10px;
        padding: 6px 4px;
        transition: all 0.2s ease;
        flex: 1;
        position: relative;
        border: none;
        background: none;
        cursor: pointer;
    }
    
    .nav-btn i {
        font-size: 18px;
        margin-bottom: 2px;
    }
    
    .nav-btn.active {
        color: var(--primary);
    }
    
    .nav-btn.active::after {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 24px;
        height: 3px;
        background: var(--primary);
        border-radius: 2px;
    }

    /* Quick Notification */
    .quick-notification {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 13px;
        font-weight: 500;
        z-index: 10000;
        animation: slideDown 0.3s ease;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    @keyframes slideDown {
        from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
    }

    /* Адаптация */
    @media (max-width: 480px) {
        .content-wrapper {
            padding-top: 148px;
        }
        
        .ad-image-container {
            width: 100px;
            height: 120px;
        }
        
        .ad-title {
            font-size: 15px;
        }
        
        .ad-price {
            font-size: 16px;
        }
    }
</style>
</head>
<body>
    <div class="app-container">
        <!-- ХЕДЕР -->
        <div class="header">
            <div class="logo">
                <i class="fa fa-diamond"></i>
                <span>Zeeptook</span>
            </div>
            <div class="header-actions">
                <a href="messages.html" class="messages-btn">
                    <i class="fa fa-comment"></i>
                </a>
            </div>
        </div>
        
        <!-- ПОИСК -->
        <div class="search-section">
            <div class="search-container">
                <div class="search-box">
                    <div class="search-icon">
                        <i class="fa fa-search"></i>
                    </div>
                    <input type="text" id="search-input" placeholder="Поиск игровых аккаунтов...">
                    <button id="search-clear-btn" style="display: none;">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- КАТЕГОРИИ -->
        <div class="categories-section">
            <div class="categories-scroll" id="categories-container">
                <!-- Категории будут загружены -->
            </div>
        </div>
        
        <!-- ОСНОВНОЙ КОНТЕНТ -->
        <div class="content-wrapper">
            <div class="main-content">
                <div class="section-header">
                    <div class="section-title">Игровые аккаунты</div>
                </div>
                
                <div class="ads-grid" id="ads-container">
                    <!-- ИНДИКАТОР ЗАГРУЗКИ -->
                    <div class="initial-loading">
                        <div class="loading-spinner"></div>
                        <div>Загрузка объявлений...</div>
                    </div>
                </div>
                
                <div class="load-more">
                    <button class="load-more-btn" id="load-more-btn" style="display: none;">Показать ещё</button>
                </div>
            </div>
        </div>
        
        <!-- НИЖНЕЕ МЕНЮ -->
        <div class="bottom-nav">
            <a href="index.html" class="nav-btn active">
                <i class="fa fa-home"></i>
                <span>Главная</span>
            </a>
            <a href="favorites.html" class="nav-btn">
                <i class="fa fa-heart"></i>
                <span>Избранное</span>
            </a>
            <a href="add-ad.html" class="nav-btn">
                <i class="fa fa-plus"></i>
                <span>Добавить</span>
            </a>
            <a href="server-page.html" class="nav-btn">
                <i class="fa fa-gamepad"></i>
                <span>Серверы</span>
            </a>
            <a href="profile.html" class="nav-btn">
                <i class="fa fa-user"></i>
                <span>Профиль</span>
            </a>
        </div>
    </div>

    <script>
    // КОНФИГУРАЦИЯ
    const CONFIG = {
        API_BASE: window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api',
        LIMIT_PER_PAGE: 4, // УМЕНЬШИЛИ ДО 4 для быстрой загрузки
        IMAGE_WIDTH: 400, // Оптимальное разрешение для телефона
        IMAGE_HEIGHT: 300,
        CACHE_TTL: 300000 // 5 минут
    };
    
    // ПЕРЕМЕННЫЕ
    let currentPage = 1;
    let totalPages = 1;
    let currentCategory = 'all';
    let currentSearch = '';
    let isLoading = false;
    let token = localStorage.getItem('token');
    
    // КАТЕГОРИИ ИГР
    const GAME_CATEGORIES = [
        { name: 'Все', data: 'all' },
        { name: 'PUBG Mobile', data: 'pubg' },
        { name: 'Free Fire', data: 'freefire' },
        { name: 'Call of Duty', data: 'cod' },
        { name: 'Genshin Impact', data: 'genshin' },
        { name: 'Mobile Legends', data: 'ml' },
        { name: 'Clash of Clans', data: 'coc' },
        { name: 'Brawl Stars', data: 'brawl' },
        { name: 'Roblox', data: 'roblox' }
    ];
    
    // КАРТИНКИ ПО УМОЛЧАНИЮ
    const DEFAULT_IMAGES = {
        pubg: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=400&h=300&fit=crop',
        freefire: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=400&h=300&fit=crop',
        cod: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=400&h=300&fit=crop',
        default: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=400&h=300&fit=crop'
    };
    
    // ==================== ОСНОВНЫЕ ФУНКЦИИ ====================
    
    // 1. БЫСТРАЯ ЗАГРУЗКА КАТЕГОРИЙ
    function loadCategories() {
        const container = document.getElementById('categories-container');
        
        GAME_CATEGORIES.forEach(cat => {
            const categoryElement = document.createElement('div');
            categoryElement.className = cat.data === 'all' ? 'category active' : 'category';
            categoryElement.textContent = cat.name;
            categoryElement.setAttribute('data-category', cat.data);
            container.appendChild(categoryElement);
            
            categoryElement.addEventListener('click', function() {
                document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                currentCategory = this.getAttribute('data-category');
                currentPage = 1;
                currentSearch = '';
                document.getElementById('search-input').value = '';
                document.getElementById('search-clear-btn').style.display = 'none';
                
                fetchAds();
            });
        });
    }
    
    // 2. ОПТИМИЗИРОВАННАЯ ЗАГРУЗКА ОБЪЯВЛЕНИЙ (с разделением данных и изображений)
    async function fetchAds() {
        if (isLoading) return;
        
        isLoading = true;
        const adsContainer = document.getElementById('ads-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        
        try {
            // Показываем индикатор загрузки только для первой страницы
            if (currentPage === 1) {
                adsContainer.innerHTML = `
                    <div class="initial-loading">
                        <div class="loading-spinner"></div>
                        <div>Загрузка объявлений...</div>
                    </div>
                `;
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'Загрузка...';
            }
            
            // ПОДГОТОВКА URL С ОГРАНИЧЕНИЕМ В 4 ЭЛЕМЕНТА
            let url;
            try {
                url = new URL(`${CONFIG.API_BASE}/ads`);
            } catch (e) {
                url = new URL('/api/ads', window.location.origin);
            }
            
            url.searchParams.append('page', currentPage);
            url.searchParams.append('limit', CONFIG.LIMIT_PER_PAGE); // ТОЛЬКО 4 ОБЪЯВЛЕНИЯ!
            
            if (currentCategory !== 'all') {
                url.searchParams.append('category', currentCategory);
            }
            if (currentSearch) {
                url.searchParams.append('search', currentSearch);
            }
            
            // ЗАГРУЗКА ДАННЫХ С ТАЙМАУТОМ
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // Уменьшенный таймаут
            
            const options = {
                method: 'GET',
                headers: {},
                signal: controller.signal
            };
            
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(url.toString(), options);
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`Ошибка ${response.status}`);
            }
            
            const data = await response.json();
            
            // ОБНОВЛЕНИЕ СОСТОЯНИЯ
            currentPage = data.page || currentPage;
            totalPages = data.totalPages || 1;
            
            // ШАГ 1: НЕМЕДЛЕННО ПОКАЗЫВАЕМ ТЕКСТОВУЮ ИНФОРМАЦИЮ
            displayAdsText(data.ads || [], currentPage === 1);
            
            // ШАГ 2: ОТДЕЛЬНО ЗАГРУЖАЕМ ИЗОБРАЖЕНИЯ (после показа текста)
            setTimeout(() => {
                loadAdsImages(data.ads || []);
            }, 100);
            
            // УПРАВЛЕНИЕ КНОПКОЙ "ЗАГРУЗИТЬ ЕЩЕ"
            if (currentPage < totalPages) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = 'Показать ещё';
            } else {
                loadMoreBtn.style.display = 'none';
            }
            
        } catch (error) {
            console.error('Ошибка загрузки:', error);
            showErrorState();
        } finally {
            isLoading = false;
        }
    }
    
    // 3. ФУНКЦИЯ ДЛЯ БЫСТРОГО ОТОБРАЖЕНИЯ ТЕКСТОВОЙ ИНФОРМАЦИИ
    function displayAdsText(adsArray, clearContainer = true) {
        const adsContainer = document.getElementById('ads-container');
        
        if (clearContainer) {
            adsContainer.innerHTML = '';
        }
        
        if (adsArray.length === 0 && clearContainer) {
            adsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fa fa-inbox"></i>
                    <h3>Объявления не найдены</h3>
                    <p>Попробуйте изменить параметры поиска</p>
                </div>
            `;
            return;
        }
        
        // СОЗДАЕМ КАРТОЧКИ С ТЕКСТОМ (БЕЗ ИЗОБРАЖЕНИЙ)
        adsArray.forEach((ad, index) => {
            const adElement = createTextOnlyAdCard(ad, index);
            adsContainer.appendChild(adElement);
            
            // Анимация появления
            setTimeout(() => {
                adElement.style.opacity = '1';
                adElement.style.transform = 'translateY(0)';
            }, index * 50);
        });
    }
    
    // 4. СОЗДАНИЕ КАРТОЧКИ ТОЛЬКО С ТЕКСТОМ
    function createTextOnlyAdCard(ad, index) {
        const adElement = document.createElement('div');
        adElement.className = 'ad-card';
        adElement.setAttribute('data-ad-id', ad.id || index);
        adElement.style.opacity = '0';
        adElement.style.transform = 'translateY(5px)';
        adElement.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        
        // ФОРМАТИРОВАНИЕ ДАННЫХ
        const priceFormatted = ad.price ? 
            new Intl.NumberFormat('ru-RU').format(ad.price) + ' ₽' : 
            'Договорная';
        
        const timeAgo = formatTimeAgo(ad.created_at);
        const gameName = getGameName(ad.category);
        
        // ПРОВЕРКА ИЗБРАННОГО
        const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        const isFavorite = favorites.some(fav => fav.id === ad.id);
        
        // HTML С ТЕКСТОМ И ЗАГОЛОВКОМ ИЗОБРАЖЕНИЯ
        adElement.innerHTML = `
            <div class="ad-text-content">
                <div class="ad-header">
                    <div class="ad-category">${gameName}</div>
                    <button class="ad-favorite ${isFavorite ? 'active' : ''}" data-ad-id="${ad.id || index}">
                        <i class="fa fa-heart"></i>
                    </button>
                </div>
                <div class="ad-title">${ad.title || 'Игровой аккаунт'}</div>
                <div class="ad-description">${ad.description || 'Аккаунт с хорошими характеристиками'}</div>
                <div class="ad-footer">
                    <div class="ad-price">${priceFormatted}</div>
                    <div class="ad-meta">${timeAgo}</div>
                </div>
            </div>
            <div class="ad-image-container" data-ad-id="${ad.id || index}">
                <div class="image-placeholder">
                    <i class="fa fa-spinner fa-spin"></i>
                    <span>Загрузка...</span>
                </div>
                <img class="ad-image" data-ad-id="${ad.id || index}" alt="${ad.title || 'Игровой аккаунт'}">
            </div>
        `;
        
        // ОБРАБОТЧИКИ
        const favoriteBtn = adElement.querySelector('.ad-favorite');
        favoriteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFavorite(ad.id || index, favoriteBtn, ad);
        });
        
        adElement.addEventListener('click', () => {
            openAdDetails(ad.id || index);
        });
        
        return adElement;
    }
    
    // 5. ОТДЕЛЬНАЯ ЗАГРУЗКА ИЗОБРАЖЕНИЙ (после текста)
    async function loadAdsImages(adsArray) {
        // Загружаем изображения по одному с задержкой
        for (let i = 0; i < adsArray.length; i++) {
            const ad = adsArray[i];
            await loadSingleImage(ad);
            
            // Небольшая задержка между загрузкой изображений
            if (i < adsArray.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
    }
    
    // 6. ЗАГРУЗКА ОДНОГО ИЗОБРАЖЕНИЯ С ОПТИМИЗАЦИЕЙ
    async function loadSingleImage(ad) {
        const imageContainer = document.querySelector(`.ad-image-container[data-ad-id="${ad.id}"]`);
        if (!imageContainer) return;
        
        const imgElement = imageContainer.querySelector('.ad-image');
        const placeholder = imageContainer.querySelector('.image-placeholder');
        
        try {
            // ПЕРВЫЙ ВАРИАНТ: Изображение из данных объявления
            let imageUrl = extractImageUrl(ad);
            
            // ВТОРОЙ ВАРИАНТ: Демо-изображение по категории
            if (!imageUrl) {
                imageUrl = DEFAULT_IMAGES[ad.category] || DEFAULT_IMAGES.default;
            }
            
            // ОПТИМИЗАЦИЯ: Добавляем параметры размера для ускорения загрузки
            if (imageUrl.includes('unsplash.com')) {
                imageUrl = `${imageUrl.split('?')[0]}?w=${CONFIG.IMAGE_WIDTH}&h=${CONFIG.IMAGE_HEIGHT}&fit=crop&auto=format`;
            }
            
            // Загрузка изображения
            await new Promise((resolve, reject) => {
                imgElement.onload = () => {
                    if (placeholder) placeholder.style.display = 'none';
                    imgElement.classList.add('loaded');
                    resolve();
                };
                
                imgElement.onerror = () => {
                    // Если ошибка, показываем заглушку
                    if (placeholder) {
                        placeholder.querySelector('i').className = 'fa fa-picture-o';
                        placeholder.querySelector('span').textContent = 'Нет фото';
                    }
                    reject();
                };
                
                imgElement.src = imageUrl;
            });
            
        } catch (error) {
            console.log('Ошибка загрузки изображения:', error);
        }
    }
    
    // 7. ИЗВЛЕЧЕНИЕ URL ИЗОБРАЖЕНИЯ ИЗ ДАННЫХ
    function extractImageUrl(ad) {
        // Вариант 1: Поле photos (массив)
        if (ad.photos && ad.photos.length > 0) {
            const firstPhoto = ad.photos[0];
            if (firstPhoto.image_data) {
                if (firstPhoto.image_data.startsWith('data:image') || 
                    firstPhoto.image_data.startsWith('http')) {
                    return firstPhoto.image_data;
                } else if (firstPhoto.image_data.length > 100) {
                    return `data:image/jpeg;base64,${firstPhoto.image_data}`;
                }
            }
        }
        
        // Вариант 2: Прямое поле image
        if (ad.image && (ad.image.startsWith('data:image') || ad.image.startsWith('http'))) {
            return ad.image;
        }
        
        return null;
    }
    
    // 8. ПОКАЗ ОШИБКИ
    function showErrorState() {
        const adsContainer = document.getElementById('ads-container');
        adsContainer.innerHTML = `
            <div class="empty-state">
                <i class="fa fa-exclamation-triangle"></i>
                <h3>Ошибка загрузки</h3>
                <p>Проверьте подключение к интернету</p>
                <button onclick="fetchAds()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 20px; cursor: pointer;">
                    Повторить
                </button>
            </div>
        `;
    }
    
    // ==================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====================
    
    function getGameName(category) {
        const gameMap = {
            'pubg': 'PUBG Mobile',
            'freefire': 'Free Fire',
            'cod': 'Call of Duty',
            'genshin': 'Genshin Impact',
            'ml': 'Mobile Legends',
            'coc': 'Clash of Clans',
            'brawl': 'Brawl Stars',
            'roblox': 'Roblox'
        };
        return gameMap[category] || category || 'Игры';
    }
    
    function formatTimeAgo(dateString) {
        if (!dateString) return '> нед';
        
        try {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays < 1) return 'сегодня';
            if (diffDays < 2) return 'вчера';
            if (diffDays < 7) return `${diffDays} д`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} нед`;
            return `${Math.floor(diffDays / 30)} мес`;
        } catch (e) {
            return '> нед';
        }
    }
    
    function toggleFavorite(adId, favoriteBtn, ad) {
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        
        if (favoriteBtn.classList.contains('active')) {
            favorites = favorites.filter(fav => fav.id !== adId);
            favoriteBtn.classList.remove('active');
            showNotification('Удалено из избранного');
        } else {
            favorites.push({
                id: adId,
                title: ad.title,
                price: ad.price,
                category: ad.category
            });
            favoriteBtn.classList.add('active');
            showNotification('Добавлено в избранное');
        }
        
        localStorage.setItem('favorites', JSON.stringify(favorites));
    }
    
    function openAdDetails(adId) {
        window.location.href = `ad-details.html?id=${adId}`;
    }
    
    function showNotification(message) {
        const existing = document.querySelector('.quick-notification');
        if (existing) existing.remove();
        
        const notification = document.createElement('div');
        notification.className = 'quick-notification';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }
    
    // ==================== ИНИЦИАЛИЗАЦИЯ ====================
    
    document.addEventListener('DOMContentLoaded', function() {
        // Загружаем категории
        loadCategories();
        
        // Настраиваем поиск
        const searchInput = document.getElementById('search-input');
        const searchClearBtn = document.getElementById('search-clear-btn');
        
        let searchTimer;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimer);
            
            if (searchInput.value.trim()) {
                searchClearBtn.style.display = 'block';
            } else {
                searchClearBtn.style.display = 'none';
            }
            
            searchTimer = setTimeout(() => {
                currentSearch = searchInput.value.trim();
                currentPage = 1;
                fetchAds();
            }, 500);
        });
        
        searchClearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchClearBtn.style.display = 'none';
            currentSearch = '';
            currentPage = 1;
            fetchAds();
        });
        
        // Кнопка "Загрузить еще"
        document.getElementById('load-more-btn').addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                fetchAds();
            }
        });
        
        // Первоначальная загрузка объявлений
        fetchAds();
        
        // Адаптивный паддинг
        function adjustPadding() {
            const contentWrapper = document.querySelector('.content-wrapper');
            contentWrapper.style.paddingTop = '152px';
        }
        
        window.addEventListener('resize', adjustPadding);
        adjustPadding();
    });
    </script>
</body>
</html>
