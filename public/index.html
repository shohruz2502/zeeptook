<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zeeptook - Игровые аккаунты</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
    /* Оптимизированные стили */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        -webkit-tap-highlight-color: transparent;
    }
    
    :root {
        --primary: #0088cc;
        --primary-dark: #0077b3;
        --secondary: #18222d;
        --accent: #ff6b6b;
        --gray-dark: #2a2f36;
        --gray-medium: #3c4350;
        --gray-light: #8e98a3;
        --white: #ffffff;
        --chat-bg: #0e1621;
        --input-bg: #242f3d;
        --nav-bg: #17212b;
        --skeleton-bg: #2a2f36;
        --skeleton-shine: rgba(255, 255, 255, 0.05);
        --gradient: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        --radius: 12px;
        --radius-sm: 8px;
    }
    
    html, body {
        height: 100%;
        overflow-x: hidden;
        background: var(--chat-bg);
        color: var(--white);
        scroll-behavior: smooth;
    }
    
    body {
        font-size: 15px;
        opacity: 0;
        animation: pageFadeIn 0.3s ease forwards;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 0;
        margin: 0;
        max-width: 768px;
        margin: 0 auto;
        width: 100%;
    }

    @keyframes pageFadeIn {
        to { opacity: 1; }
    }

    .app-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        width: 100%;
        position: relative;
    }

    /* Header */
    .header {
        background: var(--nav-bg);
        color: var(--white);
        padding: 8px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 56px;
        border-bottom: 1px solid var(--gray-dark);
        max-width: 768px;
        margin: 0 auto;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .logo {
        font-size: 17px;
        font-weight: 600;
        color: var(--white);
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .logo i {
        color: var(--primary);
        font-size: 18px;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .messages-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: var(--gradient);
        color: var(--white);
        border: none;
        border-radius: 50%;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        box-shadow: 0 2px 6px rgba(0, 136, 204, 0.3);
    }
    
    .messages-btn:active {
        transform: scale(0.95);
    }
    
    .messages-btn i {
        font-size: 16px;
    }

    /* Search Section */
    .search-section {
        background: var(--nav-bg);
        border-bottom: 1px solid var(--gray-dark);
        padding: 8px 16px;
        position: fixed;
        top: 56px;
        z-index: 999;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 768px;
        margin: 0 auto;
        left: 0;
        right: 0;
        height: 60px;
        display: flex;
        align-items: center;
    }
    
    .search-container {
        position: relative;
        width: 100%;
    }
    
    .search-box {
        display: flex;
        width: 100%;
        border-radius: 20px;
        overflow: hidden;
        background: var(--input-bg);
        border: 1px solid var(--gray-dark);
        transition: all 0.2s ease;
        height: 44px;
    }
    
    .search-box:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.2);
    }
    
    .search-box input {
        flex-grow: 1;
        padding: 10px 16px 10px 44px;
        border: none;
        background: transparent;
        font-size: 14px;
        outline: none;
        color: var(--white);
        width: 100%;
    }
    
    .search-box input::placeholder {
        color: var(--gray-light);
        font-size: 13px;
    }
    
    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-light);
        font-size: 16px;
        pointer-events: none;
    }
    
    .search-box button {
        background: transparent;
        color: var(--gray-light);
        border: none;
        padding: 0 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 44px;
        font-size: 14px;
    }
    
    .search-box button:active {
        transform: scale(0.95);
    }

    /* Categories */
    .categories-section {
        background: var(--nav-bg);
        border-bottom: 1px solid var(--gray-dark);
        position: fixed;
        z-index: 998;
        top: 116px; /* header + search */
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 768px;
        margin: 0 auto;
        left: 0;
        right: 0;
        height: 48px;
        will-change: transform;
        transform: translateY(0);
    }
    
    .categories-scroll {
        display: flex;
        overflow-x: auto;
        padding: 8px 16px;
        gap: 6px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        height: 100%;
        align-items: center;
    }
    
    .categories-scroll::-webkit-scrollbar {
        display: none;
    }
    
    .category {
        flex: 0 0 auto;
        padding: 6px 14px;
        background: var(--input-bg);
        border-radius: 18px;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s ease;
        border: 1px solid var(--gray-dark);
        cursor: pointer;
        color: var(--gray-light);
    }
    
    .category.active {
        background: var(--gradient);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 2px 6px rgba(0, 136, 204, 0.3);
    }
    
    .category:active {
        transform: scale(0.95);
    }

    /* Main Content Area */
    .content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-top: 56px;
        margin-bottom: 60px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-top: 108px; /* header + search + categories */
    }

    /* Main Content */
    .main-content {
        flex: 1;
        padding: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Section Header */
    .section-header {
        padding: 16px 16px 12px;
        background: var(--chat-bg);
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--white);
    }

    /* Ads Grid */
    .ads-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 0 16px 16px;
        background: var(--chat-bg);
        min-height: 200px;
    }

    /* Ad Card - ОПТИМИЗИРОВАННЫЙ: текст виден сразу */
    .ad-card {
        background: var(--nav-bg);
        border-radius: var(--radius);
        overflow: hidden;
        cursor: pointer;
        border: 1px solid var(--gray-dark);
        display: flex;
        flex-direction: column;
        opacity: 0;
        transform: translateY(10px);
        animation: cardAppear 0.3s ease-out forwards;
        position: relative;
    }
    
    @keyframes cardAppear {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .ad-card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    /* Optimized Image Container - Сразу показывает контент */
    .ad-image-container {
        position: relative;
        width: 100%;
        height: 160px;
        background: linear-gradient(135deg, #1c2836 0%, #2a2f36 100%);
        overflow: hidden;
        border-radius: var(--radius) var(--radius) 0 0;
    }
    
    .ad-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.3s ease;
        background: #1c2836;
    }
    
    .ad-image.loaded {
        opacity: 1;
    }
    
    .ad-image-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--gray-light);
        gap: 8px;
        background: linear-gradient(135deg, #1c2836 0%, #2a2f36 100%);
        z-index: 1;
        opacity: 1;
        transition: opacity 0.3s ease;
    }
    
    .ad-image-placeholder.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .ad-image-placeholder i {
        font-size: 24px;
        opacity: 0.5;
    }
    
    .ad-image-placeholder span {
        font-size: 11px;
        opacity: 0.7;
    }
    
    .ad-content {
        padding: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
        z-index: 2;
        position: relative;
        background: var(--nav-bg);
    }
    
    .ad-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }
    
    .ad-category {
        font-size: 11px;
        background: rgba(0, 136, 204, 0.15);
        padding: 4px 8px;
        border-radius: 10px;
        color: var(--primary);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70%;
    }
    
    .ad-favorite {
        color: var(--gray-light);
        background: transparent;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    
    .ad-favorite.active {
        color: var(--accent);
    }
    
    .ad-favorite:active {
        transform: scale(0.9);
    }
    
    .ad-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--white);
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 40px;
    }
    
    .ad-description {
        color: var(--gray-light);
        margin-bottom: 10px;
        font-size: 13px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        flex: 1;
    }
    
    .ad-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
    }
    
    .ad-price {
        font-weight: 700;
        color: var(--primary);
        font-size: 16px;
    }
    
    .ad-meta {
        font-size: 12px;
        color: var(--gray-light);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Skeleton Loading - Упрощенный */
    .skeleton-card {
        background: var(--nav-bg);
        border-radius: var(--radius);
        overflow: hidden;
        border: 1px solid var(--gray-dark);
        display: flex;
        flex-direction: column;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .skeleton-image {
        width: 100%;
        height: 160px;
        background: var(--skeleton-bg);
        border-radius: var(--radius) var(--radius) 0 0;
    }
    
    .skeleton-content {
        padding: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .skeleton-line {
        height: 12px;
        background: var(--skeleton-bg);
        border-radius: 4px;
    }
    
    .skeleton-line.short {
        width: 60%;
    }
    
    .skeleton-line.medium {
        width: 80%;
    }
    
    .skeleton-line.long {
        width: 100%;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: var(--nav-bg);
        margin: 16px;
        border-radius: var(--radius);
        border: 1px solid var(--gray-dark);
        grid-column: 1 / -1;
    }
    
    .empty-state i {
        font-size: 48px;
        color: var(--gray-light);
        margin-bottom: 20px;
        opacity: 0.6;
    }
    
    .empty-state h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: var(--white);
        font-weight: 500;
    }
    
    .empty-state p {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 25px;
        color: var(--gray-light);
    }

    /* Loading */
    .initial-loading {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray-light);
        grid-column: 1 / -1;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 136, 204, 0.2);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    /* Load More Button */
    .load-more {
        text-align: center;
        padding: 20px 16px;
        background: var(--chat-bg);
        grid-column: 1 / -1;
    }
    
    .load-more-btn {
        padding: 14px 28px;
        border: 1px solid var(--primary);
        border-radius: 25px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        background: transparent;
        color: var(--primary);
        width: 100%;
        max-width: 220px;
    }
    
    .load-more-btn:active {
        transform: scale(0.97);
        background: rgba(0, 136, 204, 0.1);
    }
    
    .load-more-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Error State */
    .error-state {
        text-align: center;
        padding: 60px 20px;
        background: var(--nav-bg);
        margin: 16px;
        border-radius: var(--radius);
        border: 1px solid var(--gray-dark);
        grid-column: 1 / -1;
    }
    
    .error-state i {
        font-size: 48px;
        color: var(--accent);
        margin-bottom: 20px;
        opacity: 0.7;
    }
    
    .error-state h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: var(--white);
        font-weight: 500;
    }
    
    .error-state p {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
        color: var(--gray-light);
    }
    
    .retry-btn {
        padding: 14px 24px;
        border: 1px solid var(--primary);
        border-radius: 25px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        background: transparent;
        color: var(--primary);
        width: 100%;
        max-width: 220px;
    }
    
    .retry-btn:active {
        transform: scale(0.97);
        background: rgba(0, 136, 204, 0.1);
    }

    /* Bottom Navigation */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--nav-bg);
        display: flex;
        justify-content: space-around;
        padding: 8px 0 10px;
        border-top: 1px solid var(--gray-dark);
        z-index: 1000;
        height: 60px;
        max-width: 768px;
        margin: 0 auto;
    }
    
    .nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--gray-light);
        font-size: 10px;
        padding: 6px 4px;
        transition: all 0.2s ease;
        flex: 1;
        position: relative;
        border: none;
        background: none;
        cursor: pointer;
    }
    
    .nav-btn i {
        font-size: 20px;
        margin-bottom: 2px;
        transition: all 0.2s ease;
    }
    
    .nav-btn.active {
        color: var(--primary);
    }
    
    .nav-btn.active i {
        transform: translateY(-1px);
    }
    
    .nav-btn.active::after {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 30px;
        height: 3px;
        background: var(--primary);
        border-radius: 2px;
    }
    
    .nav-btn:active {
        transform: scale(0.95);
    }

    /* Quick Notification */
    .quick-notification {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        animation: slideDown 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* Animations */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes slideDown {
        from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
    }

    /* Адаптация */
    @media (max-width: 480px) {
        .ad-image-container {
            height: 140px;
        }
        
        .ad-title {
            font-size: 14px;
        }
        
        .categories-scroll {
            padding: 8px 16px;
        }
        
        .category {
            padding: 5px 12px;
            font-size: 12px;
        }
        
        .content-wrapper {
            padding-top: 104px;
        }
        
        .search-box {
            height: 40px;
        }
        
        .search-box input {
            padding: 8px 16px 8px 40px;
            font-size: 13px;
        }
        
        .search-icon {
            left: 12px;
            font-size: 15px;
        }
        
        .ads-grid {
            gap: 10px;
        }
    }
    
    @media (min-width: 481px) and (max-width: 768px) {
        .ads-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .ad-image-container {
            height: 180px;
        }
    }

    /* Ховер-эффекты для ПК */
    @media (hover: hover) {
        .category:hover {
            background: var(--gray-medium);
        }
        
        .category.active:hover {
            background: var(--primary-dark);
        }
        
        .ad-favorite:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .ad-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .load-more-btn:hover {
            background: rgba(0, 136, 204, 0.1);
        }
    }
</style>
</head>
<body>
    <div class="app-container">
        <!-- ХЕДЕР -->
        <div class="header">
            <div class="logo">
                <i class="fa fa-diamond"></i>
                <span>Zeeptook</span>
            </div>
            <div class="header-actions">
                <a href="messages.html" class="messages-btn">
                    <i class="fa fa-comment"></i>
                </a>
            </div>
        </div>
        
        <!-- ПОИСК -->
        <div class="search-section" id="search-section">
            <div class="search-container">
                <div class="search-box">
                    <div class="search-icon">
                        <i class="fa fa-search"></i>
                    </div>
                    <input type="text" id="search-input" placeholder="Поиск игровых аккаунтов...">
                    <button id="search-clear-btn" style="display: none;">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- КАТЕГОРИИ -->
        <div class="categories-section" id="categories-section">
            <div class="categories-scroll" id="categories-container">
                <!-- Категории будут загружены -->
            </div>
        </div>
        
        <!-- ОСНОВНОЙ КОНТЕНТ -->
        <div class="content-wrapper">
            <div class="main-content">
                <div class="section-header">
                    <div class="section-title">Игровые аккаунты</div>
                </div>
                
                <div class="ads-grid" id="ads-container">
                    <!-- Скелетоны при первой загрузке -->
                    <div class="skeleton-card">
                        <div class="skeleton-image"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line medium"></div>
                            <div class="skeleton-line long"></div>
                            <div class="skeleton-line short" style="margin-top: auto;"></div>
                        </div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-image"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line medium"></div>
                            <div class="skeleton-line long"></div>
                            <div class="skeleton-line short" style="margin-top: auto;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="load-more">
                    <button class="load-more-btn" id="load-more-btn" style="display: none;">Показать ещё</button>
                </div>
            </div>
        </div>
        
        <!-- НИЖНЕЕ МЕНЮ -->
        <div class="bottom-nav">
            <a href="index.html" class="nav-btn active">
                <i class="fa fa-home"></i>
                <span>Главная</span>
            </a>
            <a href="favorites.html" class="nav-btn">
                <i class="fa fa-heart"></i>
                <span>Избранное</span>
            </a>
            <a href="add-ad.html" class="nav-btn">
                <i class="fa fa-plus"></i>
                <span>Добавить</span>
            </a>
            <a href="server-page.html" class="nav-btn">
                <i class="fa fa-gamepad"></i>
                <span>Серверы</span>
            </a>
            <a href="profile.html" class="nav-btn">
                <i class="fa fa-user"></i>
                <span>Профиль</span>
            </a>
        </div>
    </div>

    <script>
    // ОПТИМИЗИРОВАННЫЙ КОД - быстрая загрузка с отменой запросов
    
    // Переменные
    let currentPage = 1;
    let totalPages = 1;
    let currentCategory = 'all';
    let currentSearch = '';
    let isLoading = false;
    let isCategoriesHidden = false;
    let token = localStorage.getItem('token');
    
    // AbortController для отмены запросов
    let activeControllers = [];
    
    // Функция для отмены всех активных запросов
    function abortAllRequests() {
        activeControllers.forEach(controller => {
            controller.abort();
        });
        activeControllers = [];
        isLoading = false;
    }
    
    // Функция для создания запроса с контроллером
    function createControlledRequest(url, options = {}) {
        const controller = new AbortController();
        activeControllers.push(controller);
        
        return {
            fetch: fetch(url, {
                ...options,
                signal: controller.signal
            }),
            controller: controller
        };
    }
    
    // Функция для удаления контроллера из активных
    function removeController(controller) {
        const index = activeControllers.indexOf(controller);
        if (index > -1) {
            activeControllers.splice(index, 1);
        }
    }
    
    // Кеш для данных с ограничением размера
    const DATA_CACHE = {
        set: function(key, data, category = 'all') {
            try {
                const cacheKey = `${category}_${key}`;
                const cacheData = {
                    data: data,
                    timestamp: Date.now(),
                    category: category
                };
                // Ограничиваем размер кеша
                if (localStorage.length > 50) {
                    this.cleanOldCache();
                }
                localStorage.setItem(`cache_${cacheKey}`, JSON.stringify(cacheData));
            } catch (e) {
                console.log('Cache full');
            }
        },
        
        get: function(key, category = 'all', maxAge = 300000) { // 5 минут
            const cacheKey = `${category}_${key}`;
            const cached = localStorage.getItem(`cache_${cacheKey}`);
            if (!cached) return null;
            
            try {
                const cacheData = JSON.parse(cached);
                const age = Date.now() - cacheData.timestamp;
                
                if (age > maxAge || cacheData.category !== category) {
                    localStorage.removeItem(`cache_${cacheKey}`);
                    return null;
                }
                
                return cacheData.data;
            } catch (e) {
                return null;
            }
        },
        
        clearCategory: function(category) {
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('cache_') && key.includes(category)) {
                    localStorage.removeItem(key);
                }
            });
        },
        
        cleanOldCache: function() {
            const cacheItems = [];
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('cache_')) {
                    try {
                        const cacheData = JSON.parse(localStorage.getItem(key));
                        cacheItems.push({
                            key: key,
                            timestamp: cacheData.timestamp
                        });
                    } catch (e) {}
                }
            });
            
            // Сортируем по времени и удаляем самые старые
            cacheItems.sort((a, b) => a.timestamp - b.timestamp);
            const toRemove = cacheItems.slice(0, Math.floor(cacheItems.length * 0.3)); // Удаляем 30% старых
            toRemove.forEach(item => localStorage.removeItem(item.key));
        }
    };
    
    // Кеш для предзагруженных страниц
    const PAGE_CACHE = {
        // Предзагружаем основные страницы при первой загрузке
        preloadPages: function() {
            const pagesToPreload = [
                'profile.html',
                'favorites.html',
                'add-ad.html',
                'server-page.html',
                'messages.html'
            ];
            
            // Кешируем только структуру страниц (без данных)
            pagesToPreload.forEach(page => {
                const cacheKey = `page_${page}`;
                if (!localStorage.getItem(cacheKey)) {
                    // Сохраняем базовую информацию о странице
                    localStorage.setItem(cacheKey, JSON.stringify({
                        preloaded: true,
                        timestamp: Date.now(),
                        url: page
                    }));
                }
            });
        },
        
        // Проверяем, есть ли страница в кеше
        isPreloaded: function(page) {
            const cacheKey = `page_${page}`;
            const cached = localStorage.getItem(cacheKey);
            if (!cached) return false;
            
            try {
                const data = JSON.parse(cached);
                const age = Date.now() - data.timestamp;
                // Кеш страницы действует 24 часа
                return age < 86400000;
            } catch (e) {
                return false;
            }
        },
        
        // Получаем данные предзагруженной страницы
        getPreloadedData: function(page) {
            const cacheKey = `page_${page}`;
            const cached = localStorage.getItem(cacheKey);
            if (!cached) return null;
            
            try {
                return JSON.parse(cached);
            } catch (e) {
                return null;
            }
        }
    };
    
    // Кеш для данных пользователя (профиль, избранное)
    const USER_CACHE = {
        // Сохраняем данные пользователя
        saveUserData: function(key, data) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(`user_${key}`, JSON.stringify(cacheData));
            } catch (e) {
                console.log('Failed to save user data');
            }
        },
        
        // Получаем данные пользователя
        getUserData: function(key, maxAge = 86400000) { // 24 часа
            const cached = localStorage.getItem(`user_${key}`);
            if (!cached) return null;
            
            try {
                const cacheData = JSON.parse(cached);
                const age = Date.now() - cacheData.timestamp;
                
                if (age > maxAge) {
                    localStorage.removeItem(`user_${key}`);
                    return null;
                }
                
                return cacheData.data;
            } catch (e) {
                return null;
            }
        },
        
        // Очищаем данные пользователя
        clearUserData: function(key) {
            localStorage.removeItem(`user_${key}`);
        }
    };
    
    // Базовый URL API
    const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api';
    
    // Игровые категории
    const gameCategories = [
        { name: 'Все', data: 'all' },
        { name: 'PUBG Mobile', data: 'pubg' },
        { name: 'Free Fire', data: 'freefire' },
        { name: 'Call of Duty', data: 'cod' },
        { name: 'Genshin Impact', data: 'genshin' },
        { name: 'Mobile Legends', data: 'ml' },
        { name: 'Clash of Clans', data: 'coc' },
        { name: 'Brawl Stars', data: 'brawl' },
        { name: 'Roblox', data: 'roblox' }
    ];

    // Быстрая загрузка категорий
    function loadCategories() {
        const container = document.getElementById('categories-container');
        container.innerHTML = '';
        
        gameCategories.forEach(cat => {
            const categoryElement = document.createElement('div');
            categoryElement.className = cat.data === 'all' ? 'category active' : 'category';
            categoryElement.textContent = cat.name;
            categoryElement.setAttribute('data-category', cat.data);
            container.appendChild(categoryElement);
        });
        
        setupCategories();
    }

    // Показать скелетоны
    function showSkeletons(count = 4) {
        const adsContainer = document.getElementById('ads-container');
        adsContainer.innerHTML = '';
        
        for (let i = 0; i < count; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = 'skeleton-card';
            skeleton.innerHTML = `
                <div class="skeleton-image"></div>
                <div class="skeleton-content">
                    <div class="skeleton-line short"></div>
                    <div class="skeleton-line medium"></div>
                    <div class="skeleton-line long"></div>
                    <div class="skeleton-line short" style="margin-top: auto;"></div>
                </div>
            `;
            adsContainer.appendChild(skeleton);
        }
    }

    // Оптимизированная загрузка объявлений с отменой
    async function fetchAds(page = 1, category = 'all', search = '') {
        // Отменяем предыдущие запросы перед новым
        abortAllRequests();
        
        isLoading = true;
        const adsContainer = document.getElementById('ads-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        
        try {
            // Проверяем кеш для первой страницы
            if (page === 1 && !search) {
                const cachedData = DATA_CACHE.get(`page_${page}`, category);
                if (cachedData) {
                    displayAdsCards(cachedData.ads || [], true);
                    currentPage = cachedData.page || page;
                    totalPages = cachedData.totalPages || 1;
                    
                    // Загружаем изображения в фоне
                    setTimeout(() => {
                        loadImagesLazy(cachedData.ads || []);
                    }, 100);
                    
                    if (currentPage < totalPages) {
                        loadMoreBtn.style.display = 'block';
                    }
                    
                    // Параллельно загружаем свежие данные
                    setTimeout(() => fetchFreshAds(page, category, search), 100);
                    return;
                }
            }
            
            // Показываем скелетоны только для первой страницы
            if (page === 1) {
                showSkeletons();
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'Загрузка...';
            }

            // Загрузка свежих данных
            await fetchFreshAds(page, category, search);
            
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Запрос отменен');
                return;
            }
            
            console.error('Ошибка загрузки:', error);
            
            // Если сервер недоступен, показываем ошибку
            if (page === 1) {
                showError();
            }
        } finally {
            isLoading = false;
        }
    }

    // Загрузка свежих данных с контроллером
    async function fetchFreshAds(page, category, search) {
        const adsContainer = document.getElementById('ads-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        
        let url;
        try {
            url = new URL(`${API_BASE}/ads`);
        } catch (e) {
            url = new URL('/api/ads', window.location.origin);
        }
        
        // ЛИМИТ 4: загружаем меньше данных для быстрого парсинга
        url.searchParams.append('page', page);
        url.searchParams.append('limit', 12);
        
        if (category !== 'all') {
            url.searchParams.append('category', category);
        }
        if (search) {
            url.searchParams.append('search', search);
            DATA_CACHE.clearCategory(category);
        }

        const options = {
            method: 'GET',
            headers: {}
        };

        if (token) {
            options.headers['Authorization'] = `Bearer ${token}`;
        }

        // Создаем контролируемый запрос
        const { fetch: fetchPromise, controller } = createControlledRequest(url.toString(), options);
        
        try {
            const response = await fetchPromise;
            
            // Удаляем контроллер из активных после успешного завершения
            removeController(controller);
            
            if (!response.ok) {
                throw new Error(`Ошибка ${response.status}`);
            }

            const data = await response.json();
            
            // Кешируем данные
            if (page === 1 && !search) {
                DATA_CACHE.set(`page_${page}`, data, category);
            }
            
            currentPage = data.page || page;
            totalPages = data.totalPages || 1;
            
            // СНАЧАЛА ОТОБРАЖАЕМ КАРТОЧКИ С ТЕКСТОМ (быстро)
            displayAdsCards(data.ads || [], page === 1);
            
            // ЗАТЕМ ЗАГРУЖАЕМ ИЗОБРАЖЕНИЯ (медленно, в фоне)
            setTimeout(() => {
                loadImagesLazy(data.ads || []);
            }, 300);
            
            if (currentPage < totalPages) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = 'Показать ещё';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        } catch (error) {
            removeController(controller);
            throw error;
        }
    }

    // Функция для отображения карточек СРАЗУ (текст виден моментально)
    function displayAdsCards(adsArray, clearContainer = true) {
        const adsContainer = document.getElementById('ads-container');
        
        if (clearContainer) {
            adsContainer.innerHTML = '';
        }
        
        if (adsArray.length === 0 && clearContainer) {
            adsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fa fa-inbox"></i>
                    <h3>Объявления не найдены</h3>
                    <p>Попробуйте изменить параметры поиска</p>
                </div>
            `;
            return;
        }
        
        // Создаем карточки БЫСТРО, без ожидания изображений
        adsArray.forEach((ad, index) => {
            const adElement = createFastAdCard(ad, index);
            adsContainer.appendChild(adElement);
            
            // Анимация появления карточки
            setTimeout(() => {
                adElement.style.opacity = '1';
                adElement.style.transform = 'translateY(0)';
            }, index * 20);
        });
    }

    // Создание быстрой карточки (текст загружается сразу)
    function createFastAdCard(ad, index) {
        const adElement = document.createElement('div');
        adElement.className = 'ad-card';
        adElement.setAttribute('data-ad-id', ad.id || index);
        adElement.style.animationDelay = `${index * 0.02}s`;
        adElement.style.opacity = '0';
        adElement.style.transform = 'translateY(5px)';
        adElement.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        
        // Форматируем данные
        const priceFormatted = ad.price ? 
            new Intl.NumberFormat('ru-RU').format(ad.price) + ' ₽' : 
            'Договорная';
        
        const timeAgo = formatTimeAgo(ad.created_at);
        const gameName = getGameNameFromCategory(ad.category);
        
        // Проверяем избранное из кеша
        let isFavorite = false;
        const favoriteAd = USER_CACHE.getUserData('favorites') || [];
        if (favoriteAd.length > 0) {
            isFavorite = favoriteAd.some(fav => fav.id === ad.id);
        } else {
            // Или из старого формата localStorage
            const oldFavorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            isFavorite = oldFavorites.some(fav => fav.id === ad.id);
        }
        
        // HTML с ПУСТЫМ контейнером для изображения
        adElement.innerHTML = `
            <div class="ad-image-container" data-ad-id="${ad.id || index}">
                <div class="ad-image-placeholder">
                    <i class="fa fa-image"></i>
                    <span>Загрузка...</span>
                </div>
                <!-- Изображение будет вставлено позже -->
            </div>
            <div class="ad-content">
                <div class="ad-header">
                    <div class="ad-category">${gameName}</div>
                    <button class="ad-favorite ${isFavorite ? 'active' : ''}" data-ad-id="${ad.id || index}">
                        <i class="fa fa-heart"></i>
                    </button>
                </div>
                <div class="ad-title">${ad.title || 'Игровой аккаунт'}</div>
                <div class="ad-description">${ad.description || 'Аккаунт с хорошими характеристиками'}</div>
                <div class="ad-footer">
                    <div class="ad-price">${priceFormatted}</div>
                    <div class="ad-meta">
                        <span>${timeAgo}</span>
                    </div>
                </div>
            </div>
        `;
        
        // Назначаем обработчики
        const favoriteBtn = adElement.querySelector('.ad-favorite');
        favoriteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFavorite(ad.id || index, favoriteBtn, ad);
        });
        
        adElement.addEventListener('click', () => {
            openAdDetails(ad.id || index);
        });
        
        return adElement;
    }

    // Ленивая загрузка изображений
    function loadImagesLazy(adsArray) {
        // Создаем Intersection Observer для ленивой загрузки
        const imageContainers = document.querySelectorAll('.ad-image-container');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const container = entry.target;
                    const adId = container.getAttribute('data-ad-id');
                    
                    // Находим соответствующие данные объявления
                    const ad = adsArray.find(a => a.id == adId);
                    if (ad) {
                        loadSingleImageOptimized(ad, container);
                    }
                    
                    observer.unobserve(container);
                }
            });
        }, {
            rootMargin: '50px',
            threshold: 0.1
        });
        
        imageContainers.forEach(container => {
            observer.observe(container);
        });
    }

    // Оптимизированная загрузка одного изображения
    function loadSingleImageOptimized(ad, container) {
        const placeholder = container.querySelector('.ad-image-placeholder');
        
        // Получаем URL изображения
        let imageUrl = getOptimizedImageUrl(ad);
        
        if (!imageUrl) {
            if (placeholder) {
                placeholder.querySelector('span').textContent = 'Нет фото';
            }
            return;
        }
        
        // Создаем Image для предзагрузки
        const img = new Image();
        
        img.onload = function() {
            // Создаем элемент img
            const imgElement = document.createElement('img');
            imgElement.className = 'ad-image loaded';
            imgElement.src = imageUrl;
            imgElement.alt = ad.title || 'Игровой аккаунт';
            imgElement.loading = 'lazy';
            imgElement.style.width = '100%';
            imgElement.style.height = '100%';
            imgElement.style.objectFit = 'cover';
            
            // Вставляем изображение перед плейсхолдером
            container.insertBefore(imgElement, placeholder);
            
            // Прячем плейсхолдер
            setTimeout(() => {
                placeholder.classList.add('hidden');
            }, 300);
            
            // Анимация появления
            imgElement.style.opacity = '0';
            requestAnimationFrame(() => {
                imgElement.style.transition = 'opacity 0.3s ease';
                imgElement.style.opacity = '1';
            });
        };
        
        img.onerror = function() {
            if (placeholder) {
                placeholder.querySelector('span').textContent = 'Ошибка загрузки';
            }
        };
        
        // Начинаем загрузку
        img.src = imageUrl;
    }

    // Получение оптимизированного URL изображения
    function getOptimizedImageUrl(ad) {
        let imageUrl = '';
        
        // Проверяем разные источники изображений
        if (ad.photos && ad.photos.length > 0) {
            const firstPhoto = ad.photos[0];
            if (firstPhoto.image_data) {
                if (firstPhoto.image_data.startsWith('data:image')) {
                    // Base64 изображение - оставляем как есть
                    imageUrl = firstPhoto.image_data;
                } else if (firstPhoto.image_data.startsWith('http')) {
                    // URL изображение - используем как есть
                    imageUrl = firstPhoto.image_data;
                    
                    // Для внешних URL можно добавить параметры для оптимизации
                    if (imageUrl.includes('unsplash') || imageUrl.includes('placeholder')) {
                        // Добавляем параметры для уменьшения размера
                        imageUrl = imageUrl.replace(/(\?|&)w=\d+/, '') + '&w=400&fit=crop';
                    }
                } else if (firstPhoto.image_data.length > 100) {
                    // Base64 без префикса
                    imageUrl = `data:image/jpeg;base64,${firstPhoto.image_data}`;
                }
            }
        } else if (ad.image) {
            if (ad.image.startsWith('data:image') || ad.image.startsWith('http')) {
                imageUrl = ad.image;
            }
        }
        
        return imageUrl;
    }

    // Получение названия игры из категории
    function getGameNameFromCategory(category) {
        const gameMap = {
            'pubg': 'PUBG Mobile',
            'freefire': 'Free Fire',
            'cod': 'Call of Duty',
            'genshin': 'Genshin Impact',
            'ml': 'Mobile Legends',
            'coc': 'Clash of Clans',
            'brawl': 'Brawl Stars',
            'roblox': 'Roblox'
        };
        
        return gameMap[category] || category || 'Игры';
    }

    // Показать ошибку
    function showError() {
        const adsContainer = document.getElementById('ads-container');
        adsContainer.innerHTML = `
            <div class="error-state">
                <i class="fa fa-exclamation-triangle"></i>
                <h3>Ошибка загрузки</h3>
                <p>Не удалось загрузить объявления. Проверьте подключение к интернету.</p>
                <button class="retry-btn" onclick="fetchAds()">Повторить</button>
            </div>
        `;
    }

    // Избранное с кешированием
    function toggleFavorite(adId, favoriteBtn, ad) {
        let favorites = USER_CACHE.getUserData('favorites') || [];
        
        if (favorites.length === 0) {
            // Проверяем старый формат
            const oldFavorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            if (oldFavorites.length > 0) {
                favorites = oldFavorites;
                // Мигрируем в новый формат
                USER_CACHE.saveUserData('favorites', favorites);
                localStorage.removeItem('favorites');
            }
        }
        
        if (favoriteBtn.classList.contains('active')) {
            favorites = favorites.filter(fav => fav.id !== adId);
            favoriteBtn.classList.remove('active');
            showNotification('Удалено из избранного');
        } else {
            const favoriteAd = {
                id: adId,
                title: ad.title,
                price: ad.price,
                category: ad.category,
                description: ad.description,
                photos: ad.photos,
                created_at: ad.created_at
            };
            favorites.push(favoriteAd);
            favoriteBtn.classList.add('active');
            showNotification('Добавлено в избранное');
        }
        
        // Сохраняем в кеш пользователя
        USER_CACHE.saveUserData('favorites', favorites);
        
        // Также сохраняем в старый формат для обратной совместимости
        localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    // Открытие деталей объявления с отменой запросов
    function openAdDetails(adId) {
        // Отменяем все активные запросы перед переходом
        abortAllRequests();
        window.location.href = `ad-details.html?id=${adId}`;
    }

    // Форматирование времени
    function formatTimeAgo(dateString) {
        if (!dateString) return '> нед';
        
        try {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays < 1) return 'сегодня';
            if (diffDays < 2) return 'вчера';
            if (diffDays < 7) return `${diffDays} д`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} нед`;
            return `${Math.floor(diffDays / 30)} мес`;
        } catch (e) {
            return '> нед';
        }
    }

    // Уведомление
    function showNotification(message) {
        const existing = document.querySelector('.quick-notification');
        if (existing) existing.remove();
        
        const notification = document.createElement('div');
        notification.className = 'quick-notification';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }

    // Настройка поиска
    function setupSearch() {
        const searchInput = document.getElementById('search-input');
        const searchClearBtn = document.getElementById('search-clear-btn');
        
        const performSearch = () => {
            currentSearch = searchInput.value.trim();
            currentPage = 1;
            DATA_CACHE.clearCategory(currentCategory);
            fetchAds(1, currentCategory, currentSearch);
            
            if (currentSearch) {
                searchClearBtn.style.display = 'block';
            } else {
                searchClearBtn.style.display = 'none';
            }
        };
        
        // Поиск по кнопке
        searchClearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchClearBtn.style.display = 'none';
            performSearch();
        });
        
        // Поиск по Enter
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });
        
        // Поиск с задержкой
        let searchTimer;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(performSearch, 500);
            
            if (searchInput.value.trim()) {
                searchClearBtn.style.display = 'block';
            } else {
                searchClearBtn.style.display = 'none';
            }
        });
    }

    // Настройка категорий
    function setupCategories() {
        const categories = document.querySelectorAll('.category');
        categories.forEach(category => {
            category.addEventListener('click', function() {
                const categoryValue = this.getAttribute('data-category');
                
                categories.forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                currentCategory = categoryValue;
                currentPage = 1;
                currentSearch = '';
                document.getElementById('search-input').value = '';
                document.getElementById('search-clear-btn').style.display = 'none';
                
                fetchAds(1, currentCategory);
            });
        });
    }

    // Анимация скрытия/показа категорий
    function setupScrollAnimation() {
        const categoriesSection = document.getElementById('categories-section');
        const searchSection = document.getElementById('search-section');
        const header = document.querySelector('.header');
        const contentWrapper = document.querySelector('.content-wrapper');
        
        let lastScrollPos = window.pageYOffset || document.documentElement.scrollTop;
        
        // Оптимизированный обработчик скролла
        function handleScroll() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollDirection = scrollTop > lastScrollPos ? 'down' : 'up';
            
            // Показываем/скрываем категории
            if (scrollDirection === 'down' && scrollTop > 100 && !isCategoriesHidden) {
                categoriesSection.style.transform = 'translateY(-100%)';
                isCategoriesHidden = true;
                contentWrapper.style.paddingTop = '60px';
            } else if ((scrollDirection === 'up' || scrollTop <= 50) && isCategoriesHidden) {
                categoriesSection.style.transform = 'translateY(0)';
                isCategoriesHidden = false;
                contentWrapper.style.paddingTop = '108px';
            }
            
            // Показываем/скрываем хедер
            if (scrollTop > 200 && scrollDirection === 'down') {
                header.style.transform = 'translateY(-100%)';
                searchSection.style.transform = 'translateY(-56px)';
            } else {
                header.style.transform = 'translateY(0)';
                searchSection.style.transform = 'translateY(0)';
            }
            
            lastScrollPos = scrollTop <= 0 ? 0 : scrollTop;
        }
        
        // Троттлинг скролла
        let scrollTimeout;
        function throttledScroll() {
            if (!scrollTimeout) {
                scrollTimeout = setTimeout(() => {
                    handleScroll();
                    scrollTimeout = null;
                }, 16);
            }
        }
        
        window.addEventListener('scroll', throttledScroll, { passive: true });
        window.addEventListener('touchmove', throttledScroll, { passive: true });
    }

    // Навигация с отменой запросов
    function setupNavigation() {
        // Отменяем запросы при переходе по ссылкам
        document.addEventListener('click', function(e) {
            let target = e.target;
            
            // Ищем родительскую ссылку
            while (target && target.tagName !== 'A' && target.tagName !== 'BUTTON') {
                target = target.parentElement;
            }
            
            if (target && (target.tagName === 'A' || target.tagName === 'BUTTON')) {
                const href = target.getAttribute('href');
                const onclick = target.getAttribute('onclick');
                
                // Если это навигация на другую страницу
                if (href && href !== '#' && !href.startsWith('javascript:') && 
                    !target.classList.contains('ad-favorite') &&
                    !target.classList.contains('load-more-btn') &&
                    !target.classList.contains('retry-btn')) {
                    
                    // Отменяем все активные запросы
                    abortAllRequests();
                    
                    // Добавляем небольшую задержку для гарантии отмены
                    setTimeout(() => {
                        // Переход произойдет автоматически по href
                    }, 50);
                }
            }
        }, true);
        
        // Обработка кнопки "Назад" в браузере
        window.addEventListener('beforeunload', function() {
            abortAllRequests();
        });
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
        // Предзагружаем страницы
        PAGE_CACHE.preloadPages();
        
        // Загружаем категории
        loadCategories();
        
        // Настраиваем поиск
        setupSearch();
        
        // Настраиваем скролл-анимацию
        setupScrollAnimation();
        
        // Настраиваем навигацию
        setupNavigation();
        
        // Загружаем объявления
        fetchAds();
        
        // Кнопка "Загрузить еще"
        const loadMoreBtn = document.getElementById('load-more-btn');
        loadMoreBtn.addEventListener('click', () => {
            fetchAds(currentPage + 1, currentCategory, currentSearch);
        });
        
        // Адаптация паддинга
        function adjustContentPadding() {
            const contentWrapper = document.querySelector('.content-wrapper');
            const isMobile = window.innerWidth <= 480;
            
            if (isCategoriesHidden) {
                contentWrapper.style.paddingTop = isMobile ? '60px' : '60px';
            } else {
                contentWrapper.style.paddingTop = isMobile ? '104px' : '108px';
            }
        }
        
        window.addEventListener('resize', adjustContentPadding);
        adjustContentPadding();
        
        // Предзагрузка следующих изображений при приближении к низу
        window.addEventListener('scroll', () => {
            const scrollBottom = window.innerHeight + window.scrollY;
            const bodyHeight = document.body.offsetHeight;
            
            if (scrollBottom > bodyHeight - 500 && !isLoading && currentPage < totalPages) {
                // Автозагрузка при скролле
                fetchAds(currentPage + 1, currentCategory, currentSearch);
            }
        }, { passive: true });
    });
</script>
</body>
</html>

