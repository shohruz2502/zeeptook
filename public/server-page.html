<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–≤–µ—Ä—ã - Zeeptook</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f0f23;
            color: #ffffff;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* –°–∞–π–¥–±–∞—Ä (Telegram style) */
        .sidebar {
            width: 260px;
            background: #1e1e2e;
            border-right: 1px solid #2d2d44;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #2d2d44;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-add-server {
            width: 36px;
            height: 36px;
            background: #667eea;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .btn-add-server:hover {
            background: #5a67d8;
        }

        .search-box {
            padding: 15px 20px;
            border-bottom: 1px solid #2d2d44;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            background: #2d2d44;
            border: 1px solid #3d3d5e;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .servers-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .server-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.3s;
            border-left: 3px solid transparent;
        }

        .server-item:hover {
            background: #2d2d44;
        }

        .server-item.active {
            background: #2d2d44;
            border-left-color: #667eea;
        }

        .server-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }

        .server-info {
            flex: 1;
            min-width: 0;
        }

        .server-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .server-owner {
            font-size: 12px;
            color: #8888aa;
        }

        .server-message-count {
            background: #667eea;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 20px;
            background: #1e1e2e;
            border-bottom: 1px solid #2d2d44;
            display: none;
        }

        .content-header.active {
            display: block;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header-description {
            color: #8888aa;
            font-size: 14px;
        }

        .chat-types {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .chat-type-btn {
            padding: 10px 20px;
            background: #2d2d44;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
        }

        .chat-type-btn:hover {
            background: #3d3d5e;
        }

        .chat-type-btn.active {
            background: #667eea;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–∞—Ç–æ–≤ */
        .chat-container {
            flex: 1;
            overflow: hidden;
            display: none;
        }

        .chat-container.active {
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #0f0f23;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 70%;
            animation: fadeIn 0.3s ease;
        }

        .message.sent {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message.sent .message-content {
            background: #2d5baf;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            background: #2d2d44;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message-content {
            background: #2d2d44;
            padding: 12px 15px;
            border-radius: 15px;
            border: 1px solid #3d3d5e;
        }

        .message-header {
            display: flex;
            gap: 10px;
            align-items: baseline;
            margin-bottom: 5px;
        }

        .message-username {
            font-weight: 500;
            font-size: 13px;
            color: #aaddff;
        }

        .message-time {
            font-size: 11px;
            color: #8888aa;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }

        .chat-input-container {
            padding: 20px;
            background: #1e1e2e;
            border-top: 1px solid #2d2d44;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input textarea {
            flex: 1;
            background: #2d2d44;
            border: 1px solid #3d3d5e;
            border-radius: 20px;
            color: white;
            padding: 12px 20px;
            resize: none;
            min-height: 46px;
            max-height: 150px;
            font-family: inherit;
            font-size: 14px;
        }

        .chat-input textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-send {
            width: 46px;
            height: 46px;
            background: #667eea;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .btn-send:hover {
            background: #5a67d8;
        }

        /* –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ */
        .create-server-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .create-server-modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e1e2e;
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            border: 1px solid #3d3d5e;
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .modal-header p {
            color: #8888aa;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: #2d2d44;
            border: 1px solid #3d3d5e;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .char-count {
            text-align: right;
            font-size: 12px;
            color: #8888aa;
            margin-top: 5px;
        }

        .char-count.warning {
            color: #ff9966;
        }

        .char-count.error {
            color: #ff6666;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #2d2d44;
            color: white;
            border: 1px solid #3d3d5e;
        }

        .btn-secondary:hover {
            background: #3d3d5e;
        }

        /* –≠–∫—Ä–∞–Ω –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞ */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            color: #8888aa;
        }

        .empty-state h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: white;
        }

        .empty-state p {
            margin-bottom: 30px;
            max-width: 400px;
        }

        /* –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞ */
        .chat-selection {
            flex: 1;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .chat-selection.active {
            display: flex;
        }

        .chat-options {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .chat-option {
            width: 150px;
            height: 150px;
            background: #2d2d44;
            border: 2px solid #3d3d5e;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-option:hover {
            border-color: #667eea;
            transform: translateY(-5px);
        }

        .chat-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .chat-title {
            font-weight: 500;
            font-size: 16px;
        }

        .chat-description {
            font-size: 12px;
            color: #8888aa;
            margin-top: 5px;
        }

        /* –≠–∫—Ä–∞–Ω –æ–±–º–µ–Ω–æ–≤ */
        .exchanges-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .exchanges-list.active {
            display: block;
        }

        .exchange-item {
            background: #2d2d44;
            border: 1px solid #3d3d5e;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .exchange-item:hover {
            background: #3d3d5e;
        }

        .exchange-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .exchange-title {
            font-weight: 500;
            font-size: 16px;
        }

        .exchange-price {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .exchange-description {
            color: #8888aa;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .exchange-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exchange-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #8888aa;
        }

        .author-avatar {
            width: 24px;
            height: 24px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #3d3d5e;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4d4d6e;
        }

        /* –£—Ç–∏–ª–∏—Ç—ã */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .error-message {
            background: rgba(255, 102, 102, 0.1);
            border: 1px solid #ff6666;
            color: #ff9999;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar-header h1,
            .server-info,
            .server-owner,
            .server-message-count {
                display: none;
            }
            
            .search-box {
                padding: 10px;
            }
            
            .server-item {
                justify-content: center;
                padding: 15px 0;
            }
            
            .chat-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- –°–∞–π–¥–±–∞—Ä —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>–°–µ—Ä–≤–µ—Ä—ã</h1>
            <button class="btn-add-server" onclick="openCreateServerModal()">+</button>
        </div>
        
        <div class="search-box">
            <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤..." 
                   oninput="searchServers(this.value)">
        </div>
        
        <div class="servers-list" id="serversList">
            <!-- –°–µ—Ä–≤–µ—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content" id="mainContent">
        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ -->
        <div class="empty-state" id="emptyState">
            <h2>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤</h2>
            <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä –∏ –Ω–∞—á–Ω–∏—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏!</p>
            <button class="btn btn-primary" onclick="openCreateServerModal()">
                –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä
            </button>
        </div>

        <!-- –®–∞–ø–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ -->
        <div class="content-header" id="contentHeader">
            <div class="header-title" id="serverTitle"></div>
            <div class="header-description" id="serverDescription"></div>
            
            <div class="chat-types">
                <button class="chat-type-btn" onclick="showGeneralChat()" id="generalChatBtn">
                    –û–±—â–∏–π —á–∞—Ç
                </button>
                <button class="chat-type-btn" onclick="showExchanges()" id="exchangesBtn">
                    –û–±–º–µ–Ω—ã
                </button>
            </div>
        </div>

        <!-- –û–±—â–∏–π —á–∞—Ç -->
        <div class="chat-container" id="generalChatContainer">
            <div class="chat-messages" id="generalChatMessages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
            <div class="chat-input-container">
                <div class="chat-input">
                    <textarea id="generalChatInput" 
                              placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                              maxlength="2000"
                              oninput="autoResize(this)"></textarea>
                    <button class="btn-send" onclick="sendGeneralMessage()">‚Üí</button>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –æ–±–º–µ–Ω–æ–≤ -->
        <div class="exchanges-list" id="exchangesList">
            <!-- –û–±–º–µ–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
        </div>

        <!-- –ß–∞—Ç –æ–±–º–µ–Ω–∞ -->
        <div class="chat-container" id="exchangeChatContainer">
            <div class="chat-messages" id="exchangeChatMessages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
            <div class="chat-input-container">
                <div class="chat-input">
                    <textarea id="exchangeChatInput" 
                              placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                              maxlength="2000"
                              oninput="autoResize(this)"></textarea>
                    <button class="btn-send" onclick="sendExchangeMessage()">‚Üí</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞ -->
        <div class="chat-selection" id="chatSelection">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —á–∞—Ç–∞</h2>
            <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –≤ –æ–±—â–µ–º —á–∞—Ç–µ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –æ–±–º–µ–Ω</p>
            
            <div class="chat-options">
                <div class="chat-option" onclick="showGeneralChat()">
                    <div class="chat-icon">üí¨</div>
                    <div class="chat-title">–û–±—â–∏–π —á–∞—Ç</div>
                    <div class="chat-description">–û–±—â–∞–π—Ç–µ—Å—å —Å–æ –≤—Å–µ–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ —Å–µ—Ä–≤–µ—Ä–∞</div>
                </div>
                
                <div class="chat-option" onclick="showExchanges()">
                    <div class="chat-icon">üîÑ</div>
                    <div class="chat-title">–û–±–º–µ–Ω—ã</div>
                    <div class="chat-description">–ù–∞–π–¥–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –æ–±–º–µ–Ω</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ -->
    <div class="create-server-modal" id="createServerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä</h2>
                <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –¥–ª—è –æ–±—â–µ–Ω–∏—è –∏ –æ–±–º–µ–Ω–æ–≤</p>
            </div>
            
            <form id="createServerForm">
                <div class="form-group">
                    <label for="serverName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ *</label>
                    <input type="text" id="serverName" class="form-control" 
                           maxlength="10" required
                           placeholder="–ú–æ–π —Å–µ—Ä–≤–µ—Ä">
                    <div class="char-count" id="nameCharCount">0/10</div>
                </div>
                
                <div class="form-group">
                    <label for="serverDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="serverDescription" class="form-control" 
                              maxlength="70"
                              placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                    <div class="char-count" id="descCharCount">0/70</div>
                </div>
                
                <div id="formError" class="error-message hidden"></div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateServerModal()">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary">
                        –°–æ–∑–¥–∞—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let currentServer = null;
        let currentChatType = null;
        let currentExchange = null;
        let pollInterval = null;
        let lastMessageId = 0;
        let lastExchangeMessageId = 0;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // –£—Ç–∏–ª–∏—Ç—ã
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('ru-RU');
        }

        function getAvatarColor(userId) {
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];
            return colors[(userId || 0) % colors.length];
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
        async function loadServers() {
            try {
                const response = await fetch('/api/servers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderServersList(data.servers);
                    
                    if (data.servers.length > 0) {
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('contentHeader').classList.add('active');
                        document.getElementById('chatSelection').classList.add('active');
                        
                        // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        if (!currentServer) {
                            selectServer(data.servers[0]);
                        }
                    } else {
                        document.getElementById('emptyState').classList.remove('hidden');
                        document.getElementById('contentHeader').classList.remove('active');
                        document.getElementById('chatSelection').classList.remove('active');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤:', error);
            }
        }

        // –ü–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤
        async function searchServers(query) {
            try {
                const response = await fetch(`/api/servers/search?query=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderServersList(data.servers);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤:', error);
            }
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
        function renderServersList(servers) {
            const container = document.getElementById('serversList');
            
            if (servers.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #8888aa;">–°–µ—Ä–≤–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            container.innerHTML = servers.map(server => `
                <div class="server-item ${currentServer?.id === server.id ? 'active' : ''}" 
                     onclick="selectServer(${JSON.stringify(server)})">
                    <div class="server-avatar" style="background: ${getAvatarColor(server.id)}">
                        ${server.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="server-info">
                        <div class="server-name">${escapeHtml(server.name)}</div>
                        <div class="server-owner">${escapeHtml(server.owner_username)}</div>
                    </div>
                    ${server.message_count > 0 ? `
                        <div class="server-message-count">${server.message_count}</div>
                    ` : ''}
                </div>
            `).join('');
        }

        // –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞
        function selectServer(server) {
            currentServer = server;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ
            document.querySelectorAll('.server-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.server-item').classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('serverTitle').textContent = server.name;
            document.getElementById('serverDescription').textContent = 
                server.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —á–∞—Ç–∞
            document.getElementById('chatSelection').classList.add('active');
            document.getElementById('generalChatContainer').classList.remove('active');
            document.getElementById('exchangesList').classList.remove('active');
            document.getElementById('exchangeChatContainer').classList.remove('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —á–∞—Ç–æ–≤
            document.getElementById('generalChatBtn').classList.remove('active');
            document.getElementById('exchangesBtn').classList.remove('active');
            
            // –û—á–∏—â–∞–µ–º —á–∞—Ç—ã
            document.getElementById('generalChatMessages').innerHTML = '';
            document.getElementById('exchangeChatMessages').innerHTML = '';
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π polling
            if (pollInterval) clearInterval(pollInterval);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â–∏–π —á–∞—Ç
        async function showGeneralChat() {
            currentChatType = 'general';
            document.getElementById('chatSelection').classList.remove('active');
            document.getElementById('generalChatContainer').classList.add('active');
            document.getElementById('exchangesList').classList.remove('active');
            document.getElementById('exchangeChatContainer').classList.remove('active');
            
            document.getElementById('generalChatBtn').classList.add('active');
            document.getElementById('exchangesBtn').classList.remove('active');
            
            await loadGeneralChat();
            startPolling();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ–±–º–µ–Ω—ã
        async function showExchanges() {
            currentChatType = 'exchanges';
            document.getElementById('chatSelection').classList.remove('active');
            document.getElementById('generalChatContainer').classList.remove('active');
            document.getElementById('exchangesList').classList.add('active');
            document.getElementById('exchangeChatContainer').classList.remove('active');
            
            document.getElementById('generalChatBtn').classList.remove('active');
            document.getElementById('exchangesBtn').classList.add('active');
            
            await loadExchanges();
            
            if (pollInterval) clearInterval(pollInterval);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞
        async function showExchangeChat(exchange) {
            currentExchange = exchange;
            document.getElementById('exchangesList').classList.remove('active');
            document.getElementById('exchangeChatContainer').classList.add('active');
            
            await loadExchangeChat();
            startExchangePolling();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—â–µ–≥–æ —á–∞—Ç–∞
        async function loadGeneralChat() {
            if (!currentServer) return;
            
            try {
                const response = await fetch(`/api/servers/${currentServer.id}/general-chat`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderGeneralChat(data.messages);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—â–µ–≥–æ —á–∞—Ç–∞:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–º–µ–Ω–æ–≤
        async function loadExchanges() {
            if (!currentServer) return;
            
            try {
                const response = await fetch(`/api/servers/${currentServer.id}/exchanges`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderExchanges(data.exchanges);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–º–µ–Ω–æ–≤:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ –æ–±–º–µ–Ω–∞
        async function loadExchangeChat() {
            if (!currentExchange) return;
            
            try {
                const response = await fetch(`/api/servers/exchanges/${currentExchange.id}/chat`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderExchangeChat(data.messages);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞ –æ–±–º–µ–Ω–∞:', error);
            }
        }

        // –†–µ–Ω–¥–µ—Ä –æ–±—â–µ–≥–æ —á–∞—Ç–∞
        function renderGeneralChat(messages) {
            const container = document.getElementById('generalChatMessages');
            const userId = JSON.parse(atob(token.split('.')[1])).userId;
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                lastMessageId = 0;
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                const isSent = msg.user_id == userId;
                return `
                    <div class="message ${isSent ? 'sent' : ''}">
                        <div class="message-avatar" style="background: ${getAvatarColor(msg.user_id)}">
                            ${msg.username?.charAt(0)?.toUpperCase() || '?'}
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username">${escapeHtml(msg.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</span>
                                <span class="message-time">${formatTime(msg.created_at)}</span>
                            </div>
                            <div class="message-text">${escapeHtml(msg.content)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            lastMessageId = messages[messages.length - 1]?.id || 0;
            container.scrollTop = container.scrollHeight;
        }

        // –†–µ–Ω–¥–µ—Ä –æ–±–º–µ–Ω–æ–≤
        function renderExchanges(exchanges) {
            const container = document.getElementById('exchangesList');
            
            if (!exchanges || exchanges.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>–ü–æ–∫–∞ –Ω–µ—Ç –æ–±–º–µ–Ω–æ–≤</h3>
                        <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = exchanges.map(exchange => `
                <div class="exchange-item" onclick="showExchangeChat(${JSON.stringify(exchange).replace(/"/g, '&quot;')})">
                    <div class="exchange-header">
                        <div class="exchange-title">${escapeHtml(exchange.title)}</div>
                        ${exchange.price ? `
                            <div class="exchange-price">${exchange.price} ‚ÇΩ</div>
                        ` : ''}
                    </div>
                    <div class="exchange-description">${escapeHtml(exchange.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è')}</div>
                    <div class="exchange-footer">
                        <div class="exchange-author">
                            <div class="author-avatar" style="background: ${getAvatarColor(exchange.user_id)}">
                                ${exchange.username?.charAt(0)?.toUpperCase() || '?'}
                            </div>
                            ${exchange.username}
                        </div>
                        <div class="message-time">${formatTime(exchange.created_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        // –†–µ–Ω–¥–µ—Ä —á–∞—Ç–∞ –æ–±–º–µ–Ω–∞
        function renderExchangeChat(messages) {
            const container = document.getElementById('exchangeChatMessages');
            const userId = JSON.parse(atob(token.split('.')[1])).userId;
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ!</div>';
                lastExchangeMessageId = 0;
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                const isSent = msg.user_id == userId;
                return `
                    <div class="message ${isSent ? 'sent' : ''}">
                        <div class="message-avatar" style="background: ${getAvatarColor(msg.user_id)}">
                            ${msg.username?.charAt(0)?.toUpperCase() || '?'}
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username">${escapeHtml(msg.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</span>
                                <span class="message-time">${formatTime(msg.created_at)}</span>
                            </div>
                            <div class="message-text">${escapeHtml(msg.content)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            lastExchangeMessageId = messages[messages.length - 1]?.id || 0;
            container.scrollTop = container.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±—â–∏–π —á–∞—Ç
        async function sendGeneralMessage() {
            const input = document.getElementById('generalChatInput');
            const message = input.value.trim();
            
            if (!message || !currentServer) return;
            
            try {
                const response = await fetch(`/api/server/${currentServer.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ content: message })
                });
                
                if (response.ok) {
                    input.value = '';
                    autoResize(input);
                    await loadGeneralChat();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç –æ–±–º–µ–Ω–∞
        async function sendExchangeMessage() {
            const input = document.getElementById('exchangeChatInput');
            const message = input.value.trim();
            
            if (!message || !currentExchange) return;
            
            try {
                const response = await fetch(`/api/servers/exchanges/${currentExchange.id}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ content: message })
                });
                
                if (response.ok) {
                    input.value = '';
                    autoResize(input);
                    await loadExchangeChat();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        }

        // Polling –¥–ª—è –æ–±—â–µ–≥–æ —á–∞—Ç–∞
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            
            pollInterval = setInterval(async () => {
                if (!currentServer || lastMessageId === 0) return;
                
                try {
                    const response = await fetch(`/api/servers/${currentServer.id}/general-chat?since=${lastMessageId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.messages && data.messages.length > 0) {
                            renderNewGeneralMessages(data.messages);
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ polling:', error);
                }
            }, 3000);
        }

        // Polling –¥–ª—è —á–∞—Ç–∞ –æ–±–º–µ–Ω–∞
        function startExchangePolling() {
            if (pollInterval) clearInterval(pollInterval);
            
            pollInterval = setInterval(async () => {
                if (!currentExchange || lastExchangeMessageId === 0) return;
                
                try {
                    const response = await fetch(`/api/servers/exchanges/${currentExchange.id}/chat?since=${lastExchangeMessageId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.messages && data.messages.length > 0) {
                            renderNewExchangeMessages(data.messages);
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ polling —á–∞—Ç–∞ –æ–±–º–µ–Ω–∞:', error);
                }
            }, 3000);
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
        function openCreateServerModal() {
            document.getElementById('createServerModal').classList.add('active');
            document.getElementById('serverName').focus();
        }

        function closeCreateServerModal() {
            document.getElementById('createServerModal').classList.remove('active');
            document.getElementById('createServerForm').reset();
            document.getElementById('formError').classList.add('hidden');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
        document.getElementById('createServerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('serverName').value.trim();
            const description = document.getElementById('serverDescription').value.trim();
            
            if (!name) {
                showFormError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞');
                return;
            }
            
            if (name.length > 10) {
                showFormError('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 10 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            if (description.length > 70) {
                showFormError('–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 70 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
                submitBtn.disabled = true;
                
                const response = await fetch('/api/server/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, description })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    closeCreateServerModal();
                    currentServer = data.server;
                    await loadServers();
                } else {
                    showFormError(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞:', error);
                showFormError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // –°—á–µ—Ç—á–∏–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤
        document.getElementById('serverName').addEventListener('input', function() {
            const count = this.value.length;
            const counter = document.getElementById('nameCharCount');
            counter.textContent = `${count}/10`;
            counter.className = `char-count ${count > 10 ? 'error' : ''}`;
        });

        document.getElementById('serverDescription').addEventListener('input', function() {
            const count = this.value.length;
            const counter = document.getElementById('descCharCount');
            counter.textContent = `${count}/70`;
            counter.className = `char-count ${count > 70 ? 'error' : ''}`;
        });

        // –í—ã—Ö–æ–¥
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.querySelector('#logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                });
            }
            
            loadServers();
            
            // –ê–≤—Ç–æ—Ä–µ—Å–∞–π–∑ textarea
            window.autoResize = function(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
            };
        });

        function showFormError(message) {
            const errorElement = document.getElementById('formError');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
        window.addEventListener('beforeunload', () => {
            if (pollInterval) clearInterval(pollInterval);
        });
    </script>
</body>
</html>
